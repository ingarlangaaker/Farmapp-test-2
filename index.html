<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farmapp V3.75 (offline prototype)</title>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --b:#e6e6e6; --warn:#fffbeb; --warnb:#f59e0b; --ok:#ecfdf5; --okb:#10b981; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--fg)}
    a{color:inherit}
    .container{max-width:780px;margin:0 auto;padding:16px;padding-bottom:92px}
    .row{display:flex;gap:12px;align-items:center}
    .space{height:12px}
    .h1{font-size:20px;font-weight:900;margin:0}
    .h2{font-size:14px;font-weight:800;margin:0 0 8px}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--b);border-radius:16px;background:#fff;padding:12px}
    .card.warn{background:var(--warn);border-color:var(--warnb)}
    .card.ok{background:var(--ok);border-color:var(--okb)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:block;border:1px solid var(--b);border-radius:14px;padding:14px 12px;background:#fff;font-weight:800;text-align:center;text-decoration:none}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.danger{border-color:#c33;color:#c33}
    .badge{display:inline-block;border:1px solid var(--b);border-radius:999px;padding:6px 10px;font-size:12px;text-decoration:none;font-weight:800}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border:1px solid var(--b);border-radius:999px;font-weight:900;font-size:13px;background:#fff;text-decoration:none}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .input, select, textarea{width:100%;padding:12px;border:1px solid var(--b);border-radius:14px;font-size:15px}
    textarea{min-height:90px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border-bottom:1px solid var(--b);padding:10px 0}
    .item:last-child{border-bottom:none}
    .nav{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--b);background:#fff}
    .nav-inner{max-width:780px;margin:0 auto;display:flex}
    .nav a{flex:1;padding:12px 8px;text-align:center;text-decoration:none;color:#111;font-weight:900;font-size:12px}
    .fab{font-size:22px;font-weight:1000}
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45)}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;padding:14px;border-top:1px solid var(--b);max-height:85vh;overflow:auto}
    hr{border:none;border-top:1px solid var(--b);margin:12px 0}
    label{font-size:13px;font-weight:800}
    .small{font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--b);border-radius:999px;padding:8px 10px;font-size:12px;font-weight:900}
    .right{margin-left:auto}
    .kpi{font-size:26px;font-weight:1000}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .kbd{border:1px solid var(--b);border-bottom-width:2px;border-radius:8px;padding:2px 6px;font-size:12px}
  </style>
</head>
<body>
  <div id="app"></div>

<script>

// ===== Step V3.75: CSV eksport =====
function toCSV(rows){
  if(!rows.length) return "";
  const cols = Object.keys(rows[0]);
  const escv = (v)=> {
    const s = String(v??"");
    if(s.includes('"') || s.includes(",") || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
    return s;
  };
  const lines = [];
  lines.push(cols.map(escv).join(","));
  for(const r of rows){
    lines.push(cols.map(c=>escv(r[c])).join(","));
  }
  return lines.join("\n");
}
window.__exportCSV

// ===== Step V3.75: Eksport (Sauekontroll-lignende CSV) =====
window.__exportSauekontroll

// ===== V3.75: KPI-eksport (txt) =====
window.__exportKPI

// ===== V3.75: Eksport (enkelt kryptert) =====
window.__exportEncrypted=function(){
  const state=loadState();
  const txt=btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  downloadText('farmapp_secure.txt',txt);
};
 = function(year){
  const state = loadState();
  const y = Number(year) || new Date().getFullYear();
  const s = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU");
  const e=s.filter(a=>a.sex==="E").length, v=s.filter(a=>a.sex==="V").length, l=s.filter(a=>a.sex==="L").length;
  const lamb = state.events.filter(ev=>!ev.deletedAt && ev.type==="LAMB" && (ev.eventStart||"").startsWith(String(y))).length;
  const dead = state.events.filter(ev=>!ev.deletedAt && ev.type==="DEAD" && (ev.eventStart||"").startsWith(String(y))).length;
  const avg = flockAverageWeight(state);
  const lp = lambingPercentage(state,y);
  const b = breedingSummary(state,y);
  const missingScan = getMissingScans(state,60).length;
  const missingW = getMissingWeights(state,30).length;
  const lines=[];
  lines.push(`KPI ${y}`);
  lines.push(`Søyer: ${e} • Værer: ${v} • Lam: ${l}`);
  lines.push(`Paringer: ${b.count} • Søyer bedekket: ${b.ewes}`);
  lines.push(`Lamminger: ${lamb} • Lam per søye: ${lp!=null?lp.toFixed(2):"—"}`);
  lines.push(`Dødelighet: ${dead}`);
  lines.push(`Snittvekt (aktive m/vekt): ${avg!=null?avg.toFixed(1)+" kg":"—"}`);
  lines.push(`Mangler ultralyd (>=60d etter paring): ${missingScan}`);
  lines.push(`Mangler vekt (>=30d): ${missingW}`);
  downloadText(`kpi_${y}.txt`, lines.join("\\n"));
};


// ===== Step V3.75: Eksport sauehendelser CSV =====
window.__exportSheepEvents = function(){
  const state = loadState();
  const rows = state.events.filter(e=>!e.deletedAt).filter(e=>["MATE","SCAN","LAMB","WEIGHT","HEALTH","MOVE"].includes(e.type)).map(e=>({
    type:e.type,
    date:(e.eventStart||"").slice(0,10),
    animals: (e.animalIds||[]).map(id=> (animalById(state,id)?.tagId)||"").join("|"),
    field: fieldName(state,e.fieldId||""),
    pasture: pastureName(state, e.metadata?.pastureId||""),
    meta: JSON.stringify(e.metadata||{})
  }));
  downloadText("sauehendelser.csv", toCSV(rows.length?rows:[{type:"",date:"",animals:"",field:"",pasture:"",meta:""}]));
};
 = function(){
  const state = loadState();
  const rows = state.animals.filter(a=>a.type==="SAU").map(a=>({
    earTag:a.tagId||"",
    name:a.name||"",
    sex:a.sex||"",
    birthDate:a.birthDate||"",
    dam: (animalById(state,a.damId)?.tagId)||"",
    sire: (animalById(state,a.sireId)?.tagId)||"",
    status:a.status||""
  }));
  downloadText("sauekontroll_dyr.csv", toCSV(rows.length?rows:[{earTag:"",name:"",sex:"",birthDate:"",dam:"",sire:"",status:""}]));
};
 = function(kind){
  const state = loadState();
  if(kind==="animals"){
    const rows = state.animals.map(a=>({
      id:a.id, type:a.type, tagId:a.tagId||"", name:a.name||"", sex:a.sex||"", breed:a.breed||"", birthDate:a.birthDate||"", status:a.status
    }));
    downloadText("dyr.csv", toCSV(rows));
  }
  if(kind==="events"){
    const rows = state.events.filter(e=>!e.deletedAt).map(e=>({
      id:e.id, type:e.type, title:e.title||"", fieldId:e.fieldId||"", eventStart:e.eventStart||"",
      animals:(e.animalIds||[]).join("|"),
      meta: JSON.stringify(e.metadata||{})
    }));
    downloadText("hendelser.csv", toCSV(rows));
  }
};



// ===== Step V3.75: UX helpers =====
function debounce(fn, ms=200){
  let t=null;
  return (...args)=>{
    if(t) clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}


const KEY = "farmapp_v1_state";
const nowISO = ()=> new Date().toISOString();
const uid = ()=> Math.random().toString(36).slice(2) + Date.now().toString(36);

const defaultState = {
  meta: { version: 12, createdAt: nowISO() },
  farm: { name: "Min gård", kommune: "", ksl: false, produksjoner: ["sau"] },
  animals: [], fields: [], events: [], tasks: [], customers: [], work: { running: null }
};


// ===== Step V3.75: Versioning + migration =====
const APP_VERSION = "1.25";

// ===== Step V3.75: Gårdsprofiler (lokalt) =====
function profilesKey(){ return "farmapp_profiles_v1"; }
function listProfiles(){
  try{ return JSON.parse(localStorage.getItem(profilesKey())||"[]"); }catch{ return []; }
}
function saveProfiles(arr){ localStorage.setItem(profilesKey(), JSON.stringify(arr||[])); }
function getActiveProfileId(){
  return localStorage.getItem("farmapp_active_profile") || "default";
}
function setActiveProfileId(id){
  localStorage.setItem("farmapp_active_profile", id||"default");
}
function storageKeyForProfile(id){ return `farmapp_state_${id||"default"}`; }

function migrateState(state){
  state = state || {};
  if(!state.meta) state.meta = {};
  if(!state.meta.schemaVersion) state.meta.schemaVersion = 1;
  state.meta.appVersion = APP_VERSION;
  state.meta.updatedAt = nowISO();

  if(!Array.isArray(state.animals)) state.animals = [];
  if(!Array.isArray(state.fields)) state.fields = [];
  if(!Array.isArray(state.events)) state.events = [];
  if(!Array.isArray(state.tasks)) state.tasks = [];

  for(const t of state.tasks){ if(!t.meta) t.meta = {}; }
  for(const f of state.fields){
    if(f.active===undefined) f.active = true;
    if(!f.crop) f.crop = "GROVFOR";
  }
  ensurePastures(state);
  ensureMeds(state);

  for(const e of state.events){
    if(!e.metadata) e.metadata = {};
    if(!Array.isArray(e.animalIds)) e.animalIds = [];
  }
  state = migrateState(state);
  saveState(state);
  return state;
}

function loadState(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    const s = { ...structuredClone(defaultState), ...parsed };
    for (const e of (s.events||[])) { if(!e.metadata) e.metadata = {}; }
    if(!s.meta) s.meta = { version: 12, createdAt: nowISO() };
    return s;
  }catch{ return structuredClone(defaultState); }
}
function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }
function exportJSON(){ return JSON.stringify(loadState(), null, 2); }
function importJSON(txt){
  const parsed = JSON.parse(txt);
  if(!parsed || !parsed.meta) throw new Error("Ugyldig backup");
  saveState(parsed);
}
function softDeleteEvent(state, eventId){
  const e = state.events.find(x=>x.id===eventId);
  if(e) e.deletedAt = nowISO();
}

function h(html){
  const t = document.createElement("template");
  t.innerHTML = html.trim();
  return t.content.firstElementChild;
}
function setApp(node){
  const root = document.querySelector("#app");
  root.innerHTML = "";
  root.appendChild(node);
}
function fmtDate(iso){ try{return new Date(iso).toLocaleDateString("nb-NO");}catch{return "";} }
function fmtDateTime(iso){ try{return new Date(iso).toLocaleString("nb-NO");}catch{return "";} }
function pad(n){ return String(n).padStart(2,"0"); }
function toDateTimeLocal(iso){
  const d = iso ? new Date(iso) : new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function minutesBetween(aISO,bISO){
  const a = new Date(aISO).getTime(), b = new Date(bISO).getTime();
  return Math.max(0, Math.round((b-a)/60000));
}
function copyToClipboard(text){
  navigator.clipboard?.writeText(text).then(()=>alert("Kopiert til utklippstavle")).catch(()=>alert("Kunne ikke kopiere (nettleser)"));
}

function route(){
  const hash = (location.hash || "#/dashboard").replace("#","");
  const [path, query] = hash.split("?");
  const params = new URLSearchParams(query||"");
  return { path, params };
}
function nav(path){ location.hash = `#${path}`; }

function bottomNav(active){
  const is = (p)=> active===p ? "style='color:#000'" : "style='color:#444'";
  return h(`
    <div class="nav">
      <div class="nav-inner">
        <a ${is("/dashboard")} href="#/dashboard">Dashboard</a>
        <a ${is("/animals")} href="#/animals">Dyr</a>
        <a ${is("/quick")} href="#/quick"><span class="fab">+</span></a>
        <a ${is("/fields")} href="#/fields">Skifter</a>
        <a ${is("/log")} href="#/log">Logg</a>
      <div class="card">Beiter totalt: <b>${pastureCount(state)}</b><div class="card">Dokumenter totalt: <b>${documentCount(state)}</b><div class="card">Beiteflyttinger: <b>${pastureUsageEvents(state)}</b></div>
    </div>
  `);
}

function newAnimal({tagNumber, category, birthYear}){ return { id: uid(), tagNumber, category, birthYear: Number(birthYear), status:"AKTIV" }; }
function newField({name, areaDaa}){ return { id: uid(), name, areaDaa: Number(areaDaa), active: true, crop: 'GROVFOR' }; }
function newEvent

// ===== Step V3.75: Auto-opprett lam ved lamming =====
function autoCreateLambsFromEvent

// ===== Step V3.75: Infer paringsvær til lamming =====
function inferSireFromMating

// ===== V3.75: Forventet lamming (liste) =====
function getDueDateForEwe(state, eweId){
  const mate = state.events.filter(e=>!e.deletedAt && e.type==="MATE" && (e.animalIds||[]).includes(eweId) && e.eventStart)
    .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  if(!mate) return null;
  const t = new Date(mate.eventStart);
  t.setDate(t.getDate()+150);
  return t.toISOString().slice(0,10);
}
function getDueEwes(state, daysAhead=21){
  const now = new Date();
  const end = new Date(now.getTime() + daysAhead*24*60*60*1000);
  const out=[];
  for(const ewe of state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E")){
    const due = getDueDateForEwe(state, ewe.id);
    if(!due) continue;
    const d = new Date(due+"T12:00:00Z");
    if(d>=now && d<=end){
      out.push({eweId:ewe.id, due});
    }
  }
  return out.sort((a,b)=> (a.due||"").localeCompare(b.due||""));
}
(state, damId, lambDateIso){
  if(!damId || !lambDateIso) return "";
  const lambTime = new Date(lambDateIso).getTime();
  const mates = state.events.filter(e=>!e.deletedAt && e.type==="MATE" && (e.animalIds||[]).includes(damId) && e.metadata?.sireId && e.eventStart)
    .map(e=>({sireId:e.metadata.sireId, t:new Date(e.eventStart).getTime()}))
    .filter(x=>isFinite(x.t) && x.t<=lambTime)
    .sort((a,b)=> b.t-a.t);
  const best = mates[0];
  if(!best) return "";
  const days = (lambTime-best.t)/(1000*60*60*24);
  if(days>200) return ""; // too old
  return best.sireId;
}


// ===== Step V3.75: Avvenning flag =====
function applyWeanEvent

// ===== Step V3.75: Sett dyr inaktiv ved salg/slakt =====
function applySaleSlaughter

// ===== V3.75: Sett dyr inaktiv ved død =====
function applyDeathEvent(state, ev){
  if(ev.type!=="DEAD") return;
  for(const id of (ev.animalIds||[])){
    const a = animalById(state,id);
    if(a) a.status="INAKTIV";
  }
}
(state, ev){
  if(ev.type!=="SALE" && ev.type!=="SLAUGHTER") return;
  for(const id of (ev.animalIds||[])){
    const a = animalById(state,id);
    if(a) a.status="INAKTIV";
  }
}
(state, ev){
  if(ev.type!=="WEAN") return;
  for(const id of (ev.animalIds||[])){
    const a = animalById(state,id);
    if(a) a.weanedAt = (ev.eventStart||"").slice(0,10);
  }
}
(state, ev){
  if(ev.type!=="LAMB") return;
  const damIds = (ev.animalIds||[]).slice(); // selected animals in event sheet
  const damId = damIds.length===1 ? damIds[0] : "";
  const sireId = ev.metadata?.sireId || ""; // optionally set via previous mate event later
  const tags = (ev.metadata?.lambTags||[]).filter(Boolean);
  if(!tags.length || !damId) return;
  const date = (ev.eventStart||"").slice(0,10);
  for(const tag of tags){
    if(state.animals.some(a=>a.status==="AKTIV" && a.type==="SAU" && a.tagId===tag)) continue;
    state.animals.push(newAnimal({name: tag, type:"SAU", tagId: tag, sex:"L", breed:"", birthDate: date, damId, sireId}));
  }
}
({type, animalIds=[], fieldId=null, title="", description="", metadata={}, eventStart=null, eventEnd=null}){
  return { id: uid(), type, animalIds, fieldId, title, description, metadata, eventStart: eventStart ?? nowISO(), eventEnd, deletedAt: null };
}
function newTask({title, dueDate, animalId=null, fieldId=null, description=""}){
  return { id: uid(), title, description, dueDate, animalId, fieldId, completed:false };
}

function getLastEvent(state, predicate){
  return state.events.filter(e=>!e.deletedAt).filter(predicate).sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
}
function getLastWeightKgForAnimal

// ===== Step V3.75: Tilvekst (enkel) =====
function getWeightSeries(state, animalId){
  return state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="WEIGHT" && (e.animalIds||[]).includes(animalId))
    .map(e=>({at:e.eventStart, kg:Number(e.metadata?.kg)}))
    .filter(x=>isFinite(x.kg) && x.at)
    .sort((a,b)=> (a.at||"").localeCompare(b.at||""));
}
function calcDailyGain

// ===== V3.75: Gjennomsnittlig vekt =====
function flockAverageWeight(state){
  const active = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU");
  let sum=0, n=0;
  for(const a of active){
    const last = getLastWeightKgForAnimal(state,a.id);
    if(last){ sum+=last.kg; n++; }
  }
  return n? (sum/n) : null;
}
(series){
  if(series.length<2) return null;
  const a=series[0], b=series[series.length-1];
  const days = (new Date(b.at).getTime()-new Date(a.at).getTime())/(1000*60*60*24);
  if(!isFinite(days) || days<=0) return null;
  return (b.kg-a.kg)/days;
}
(state, animalId){
  const ev = getLastEvent(state, e=>e.type==="WEIGHT" && e.animalIds?.includes(animalId));
  const kg = ev?.metadata?.kg;
  return (typeof kg==="number") ? { kg, at: ev.eventStart } : null;
}
function getMissingWeights(state, days=30){
  const cutoff = Date.now() - days*24*60*60*1000;
  return state.animals.filter(a=>a.status==="AKTIV").filter(a=>{
    const last = getLastWeightKgForAnimal(state,a.id);
    if(!last) return true;
    return new Date(last.at).getTime() < cutoff;
  });
}
function overdueTasks(state){
  const today = new Date(); today.setHours(0,0,0,0);
  return state.tasks.filter(t=>!t.completed && new Date(t.dueDate).getTime() < today.getTime());
}
function fieldName(state, id){ const f = state.fields.find(x=>x.id===id); return f ? f.name : ""; }
function labelAnimals(state, ids){
  if(!ids || !ids.length) return "—";
  if(ids.length===1){ const a = state.animals.find(x=>x.id===ids[0]); return a ? a.tagNumber : "1 dyr"; }
  return `${ids.length} dyr`;
}
function labelType(t){
  return ({
    "TREATMENT":"Behandling","WEIGHT":"Vekt","MOVE":"Flytting","NOTE":"Notat",
    "LEIEKJORING":"Leiekjøring","SPRAY":"Sprøyting","FERTILIZE":"Gjødsling",
    "DEAD":"Død","CHECK":"Tilsyn","MATE":"Paring","SCAN":"Ultralyd","LAMB":"Lamming","SALE":"Salg","SLAUGHTER":"Slakt","WEAN":"Avvenning"
  }[t] || t);
}

function kslWarningsForEvent(state, ev){
  const warn = [];
  if(!state.farm.ksl) return warn;
  if(ev.type==="SPRAY"){
    const m = ev.metadata||{};
    if(!ev.fieldId) warn.push("Sprøyting mangler skifte.");
    if(!m.product) warn.push("Mangler middel.");
    if(!m.dose) warn.push("Mangler dose.");
    if(!m.operator) warn.push("Mangler utførende.");
    if(!m.reason) warn.push("Mangler formål.");
  }
  if(ev.type==="FERTILIZE"){
    const m = ev.metadata||{};
    if(!ev.fieldId) warn.push("Gjødsling mangler skifte.");
    if(!m.kind) warn.push("Mangler type.");
    if(!m.amount) warn.push("Mangler mengde.");
  }
  return warn;
}

function sprayJournal(state, ev){
  const f = ev.fieldId ? fieldName(state, ev.fieldId) : "—";
  const m = ev.metadata||{};
  return [
    "SPRØYTEJOURNAL (prototype)",
    `Dato/tid: ${fmtDateTime(ev.eventStart)}`,
    `Skifte: ${f}`,
    `Middel: ${m.product || "—"}`,
    `Dose: ${m.dose || "—"}`,
    `Vannmengde: ${m.water || "—"}`,
    `Utførende: ${m.operator || "—"}`,
    `Vær: ${m.weather || "—"}`,
    `Formål: ${m.reason || "—"}`,
    ev.description ? `Kommentar: ${ev.description}` : null,
  ].filter(Boolean).join("\n");
}
function fertilizeJournal(state, ev){
  const f = ev.fieldId ? fieldName(state, ev.fieldId) : "—";
  const m = ev.metadata||{};
  return [
    "GJØDSELJOURNAL (prototype)",
    `Dato/tid: ${fmtDateTime(ev.eventStart)}`,
    `Skifte: ${f}`,
    `Type: ${m.kind || "—"}`,
    `Mengde: ${m.amount || "—"}`,
    (m.kind==="MINERAL" ? `NPK: ${m.npk || "—"}` : `Gjødselverdier: ${m.values || "—"}`),
    ev.description ? `Kommentar: ${ev.description}` : null,
  ].filter(Boolean).join("\n");
}




function parseNPK(npkString){
  if(!npkString) return null;
  const parts = npkString.split("-");
  if(parts.length!==3) return null;
  const n = parseFloat(parts[0]);
  const p = parseFloat(parts[1]);
  const k = parseFloat(parts[2]);
  if(isNaN(n)) return null;
  return { n, p: isNaN(p)?0:p, k: isNaN(k)?0:k };
}





function estimateYieldResponse(crop, nPerDaa){
  if(!nPerDaa) return null;

  // Very simplified response curves (demo model)
  const models = {
    GROVFOR: {opt:18, max:1200},
    KORN: {opt:20, max:700},
    POTET: {opt:22, max:3500}
  };

  const m = models[crop];
  if(!m) return null;

  const ratio = Math.min(nPerDaa / m.opt, 1.2);
  const yieldEstimate = m.max * ratio * (ratio <= 1 ? 1 : (1 - (ratio-1)*0.5));

  return {
    estimatedYield: Math.max(0, yieldEstimate),
    optimalN: m.opt
  };
}

function getYearWheel(crop){
  const wheels = {
    GROVFOR: [
      {month:"April", task:"Gjødsling vår"},
      {month:"Mai", task:"Førsteslått planlegging"},
      {month:"Juni", task:"Førsteslått"},
      {month:"August", task:"Andreslått"},
      {month:"September", task:"Høstgjødsling vurdering"}
    ],
    KORN: [
      {month:"April", task:"Såing"},
      {month:"Mai", task:"Ugraskontroll"},
      {month:"Juli", task:"Soppbehandling vurdering"},
      {month:"August", task:"Tresking"}
    ],
    POTET: [
      {month:"Mai", task:"Setting"},
      {month:"Juni", task:"Hypping"},
      {month:"Juli", task:"Tørråtekontroll"},
      {month:"September", task:"Opptak"}
    ]
  };
  return wheels[crop] || [];
}


// ===== Step V3.75: NPK presets =====
const NPK_PRESETS = [
  {name:"Fullgjødsel 22-3-10", npk:"22-3-10"},
  {name:"Fullgjødsel 25-2-6", npk:"25-2-6"},
  {name:"Kalksalpeter 15,5-0-0", npk:"15.5-0-0"},
  {name:"OPT-NS 27-0-0", npk:"27-0-0"},
  {name:"PK 0-10-20", npk:"0-10-20"}
];

const N_NORMS = {
  "GROVFOR": 18,
  "KORN": 20,
  "POTET": 22,
  "ENG": 16
};

// ===== Module: Økonomi light (V3.75) =====

// ===== Step V3.75: Prisinnstillinger (lokalt) =====
function priceKey(){ return "farmapp_price_cfg_v1"; }
function getPriceConfig(){
  try{ return JSON.parse(localStorage.getItem(priceKey())||"{}"); }catch{ return {}; }
}
function savePriceConfig(cfg){ localStorage.setItem(priceKey(), JSON.stringify(cfg||{})); }
function pricesForCrop(crop){
  const base = { yieldPrice: 1.5, nCostPerKg: 18 };
  const defaults = {
    GROVFOR: { yieldPrice: 1.5, nCostPerKg: 18 },
    ENG: { yieldPrice: 1.2, nCostPerKg: 18 },
    KORN: { yieldPrice: 3.0, nCostPerKg: 18 },
    POTET: { yieldPrice: 2.5, nCostPerKg: 18 }
  };
  const cfg = getPriceConfig();
  return { ...(defaults[crop]||base), ...(cfg[crop]||{}) };
}

function estimateEconomy(crop, nPerDaa, estimatedYield, areaDaa){
  const prices = null;
  const p = pricesForCrop(crop);
  if(!p) return null;
  // p has yieldPrice, nCostPerKg
  const totalN = (Number(nPerDaa)||0) * (Number(areaDaa)||0);
  const nCost = totalN * p.nCostPerKg;
  const revenue = (Number(estimatedYield)||0) * (Number(areaDaa)||0) * p.yieldPrice;
  return { nCost, revenue, margin: revenue - nCost };
}




function estimateHusdyrN(amountText, areaDaa){
  if(!amountText) return 0;
  const txt = amountText.toLowerCase().replace(",", ".");
  const num = parseFloat(txt);
  if(isNaN(num)) return 0;

  let totalM3 = 0;

  if(txt.includes("m3/daa")){
    totalM3 = num * areaDaa;
  }else if(txt.includes("m3")){
    totalM3 = num;
  }else{
    return 0;
  }

  const N_PER_M3 = 3; // standard estimat (kan gjøres justerbart senere)
  return totalM3 * N_PER_M3;
}

function calculateRealN(state, fieldId, year){
  const f = state.fields.find(x=>x.id===fieldId);
  if(!f) return null;
  const area = Number(f.areaDaa)||0;
  if(!area) return null;

  const events = state.events.filter(e=>!e.deletedAt)
    .filter(e=>e.type==="FERTILIZE")
    .filter(e=>e.fieldId===fieldId)
    .filter(e=> (e.eventStart||"").startsWith(String(year)));

  let totalNkg = 0;

  
  for(const e of events){

    const m = e.metadata||{};
    const amountText = m.amount||"";
    const npk = parseNPK(m.npk||"");
    if(!npk) continue;

    const num = parseFloat(amountText.replace(",", "."));
    if(isNaN(num)) continue;

    let totalKg = 0;
    if(amountText.toLowerCase().includes("kg/daa")){
      totalKg = num * area;
    }else if(amountText.toLowerCase().includes("kg")){
      totalKg = num;
    }

    
    totalNkg += totalKg * (npk.n/100);
    
  }

  
  // Add husdyrgjødsel N
  for(const e of events){
    const m = e.metadata||{};
    if(m.kind==="HUSDYR"){
      totalNkg += estimateHusdyrN(m.amount||"", area);
    }
  }

  return { totalNkg, perDaa: area ? totalNkg/area : 0 };

}

function calculateNperDaa(state, fieldId, year){
  const f = state.fields.find(x=>x.id===fieldId);
  if(!f) return null;
  const area = Number(f.areaDaa)||0;
  if(!area) return null;

  const events = state.events.filter(e=>!e.deletedAt)
    .filter(e=>e.type==="FERTILIZE")
    .filter(e=>e.fieldId===fieldId)
    .filter(e=> (e.eventStart||"").startsWith(String(year)));

  let totalKg = 0;
  
  for(const e of events){

    const m = e.metadata||{};
    const amount = m.amount||"";
    const num = parseFloat(amount.replace(",", "."));
    if(!isNaN(num)){
      if(amount.toLowerCase().includes("kg/daa")){
        totalKg += num * area;
      }else if(amount.toLowerCase().includes("kg")){
        totalKg += num;
      }
    }
  }

  const perDaa = area ? totalKg/area : 0;
  return { totalKg, perDaa };
}

function runLightRules

// ===== Step V3.75: Tilbakehold-varsling =====
function daysBetween(aIso, bIso){
  const a = new Date(aIso).getTime(), b = new Date(bIso).getTime();
  return Math.floor((b-a)/(1000*60*60*24));
}
function getWithdrawAlerts(state){
  const alerts=[];
  const now = new Date().toISOString();
  for(const e of (state.events||[])){
    if(e.deletedAt) continue;
    if(e.type!=="HEALTH") continue;
    const wd = Number(e.metadata?.withdrawDays||0);
    if(!wd) continue;
    const start = e.eventStart||"";
    if(!start) continue;
    const left = wd - daysBetween(start, now);
    if(left>0){
      for(const id of (e.animalIds||[])){
        const a = animalById(state,id);
        if(a && a.status==="AKTIV") alerts.push({animalId:id, left, product:e.metadata?.product||"Behandling", at:start});
      }
    }
  }
  return alerts.sort((a,b)=> b.left-a.left).slice(0,50);
}
(state){
  const issues = [];
  for(const e of (state.events||[])){
    if(e.deletedAt) continue;
    if(!e.eventStart) issues.push({type:"error", msg:"Hendelse uten dato"});

    if(e.type==="SPRAY"){
      const m=e.metadata||{};
      if(!m.product) issues.push({type:"warn", msg:"Sprøyting uten produkt"});
      if(!m.dose) issues.push({type:"warn", msg:"Sprøyting uten dose"});
      if(!m.operator) issues.push({type:"warn", msg:"Sprøyting uten utførende"});
    }

    if(e.type==="FERTILIZE"){
      const m=e.metadata||{};
      if(!m.kind) issues.push({type:"warn", msg:"Gjødsling uten type"});
      if(!m.amount) issues.push({type:"warn", msg:"Gjødsling uten mengde"});
    }
  }

  for(const t of (state.tasks||[])){
    if(!t.dueDate) issues.push({type:"warn", msg:"Planlagt oppgave uten dato"});
  }

  return issues;
}

function pageDashboard(state){
  const issues = runLightRules(state);

  const recent = state.events.filter(e=>!e.deletedAt).sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||"")).slice(0,6);
  const missW = getMissingWeights(state, 30);
  const od = overdueTasks(state);
  const work = state.work.running;

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">${state.farm.name}</div>
          <div class="muted">V3.75 • flokkhåndtering (hurtig) + journaler</div>
        </div>
        <a class="badge" href="#/selftest">Selvtest</a>
        <a class="badge" href="#/profiles">Profiler</a>
      </div>

      <div class="space"></div>

      ${(state.farm.ksl || od.length || missW.length || work) ? `
        <div class="card warn">
          <div class="h2">Assistent</div>
          <div class="list">
            ${state.farm.ksl ? `<div class="item"><b>KSL aktiv</b> <span class="muted">– journaler varsler ved mangler.</span></div>` : ``}
            ${work ? `<div class="item"><b>Leiekjøring pågår</b> <span class="muted">– startet ${fmtDateTime(work.startedAt)}</span></div>` : ``}
            ${od.length ? `<div class="item"><b>${od.length} forfalte oppgaver</b> <span class="muted">– gå til Oppgaver.</span></div>` : ``}
            ${missW.length ? `<div class="item"><b>${missW.length} dyr mangler vekt siste 30 dager</b> <span class="muted">– Åpne flokk → Vekt.</span></div>` : ``}
          </div>
          <div class="space"></div>
          
      <div class="space"></div>
      <div class="card">
        <div class="h2">Dette må rettes</div>
        ${issues.length ? issues.map(i=>`
          <div class="item">${i.msg}</div>
        `).join("") : `<div class="muted">Ingen mangler registrert.</div>`}
      </div>

      <div class="grid2">
        <div class="card"><div class="muted">Sau-rapport</div>${(() => { const b=breedingSummary(state,year); return `<div class="muted">Paringer: <b>${b.count}</b> • Søyer bedekket: <b>${b.ewes}</b></div>`; })()}${(() => { const s=state.animals.filter(a=>a.status==="AKTIV"&&a.type==="SAU"); const e=s.filter(a=>a.sex==="E").length, v=s.filter(a=>a.sex==="V").length, l=s.filter(a=>a.sex==="L").length; const lamb=state.events.filter(ev=>!ev.deletedAt && ev.type==="LAMB" && (ev.eventStart||"").startsWith(String(year))).length; return `<div class="muted">Søyer: <b>${e}</b> • Værer: <b>${v}</b> • Lam: <b>${l}</b></div><div class="muted">Lamminger: <b>${lamb}</b></div>`; })()}</div>
        <div class="card">
          <div class="h2">Sau KPI</div>
          ${(() => { const h=getYearHistory(state,5); return `<div class='muted small'>${h.map(x=>x.year+': '+x.lamb+' lam / '+x.dead+' døde').join(' • ')}</div>`; })()}
          <div class="muted">Snittvekt: ${(() => { const v=flockAverageWeight(state); return v? v.toFixed(1)+" kg":"—"; })()}</div>
          <div class="muted">Dødelighet i år: ${(() => { const y=new Date().getFullYear(); return state.events.filter(e=>!e.deletedAt && e.type==="DEAD" && (e.eventStart||"").startsWith(String(y))).length; })()}</div>
          ${(() => {
            const s=state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU");
            const e=s.filter(a=>a.sex==="E").length, v=s.filter(a=>a.sex==="V").length, l=s.filter(a=>a.sex==="L").length;
            const mw=getMissingWeights(state,30).length;
            return `<div class="muted">Søyer: <b>${e}</b> • Værer: <b>${v}</b> • Lam: <b>${l}</b></div><div class="muted">Mangler vekt: <b>${mw}</b></div>`;
          })()}
        </div>
            <a class="btn" href="#/insights">Innsikt</a>
            <a class="btn" href="#/flock">Flokk</a>
          </div>
        </div>
        <div class="space"></div>
      ` : `
        <div class="card ok">
          <div class="h2">Status</div>
          <div class="muted">Ingen varsler akkurat nå.</div>
          <div class="space"></div>
          <div class="grid2">
            <a class="btn" href="#/insights">Innsikt</a>
            <a class="btn" href="#/flock">Flokk</a>
          </div>
        </div>
        <div class="space"></div>
      `}

      <div class="grid2">
        <div class="card">
          <div class="muted">Aktive dyr</div>
          <div class="kpi">${state.animals.filter(a=>a.status==="AKTIV").length}</div>
        </div>
        <div class="card">
          <div class="muted">Skifter</div>
          <div class="kpi">${state.fields.filter(f=>f.active).length}</div>
        </div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Hurtig</div>
        <div class="grid2">
          <a class="btn" href="#/log?new=TREATMENT">Behandling</a>
          <a class="btn" href="#/log?new=WEIGHT">Vekt</a>
          <a class="btn" href="#/log?new=SPRAY">Sprøyting</a>
          <a class="btn" href="#/log?new=FERTILIZE">Gjødsling</a>
          <a class="btn" href="#/work">Leiekjøring</a>
          <a class="btn" href="#/tasks?new=1">Oppgave</a>
        </div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Siste hendelser</div>
        ${recent.length ? `
          <div class="list">
            ${recent.map(e=>`
              <div class="item">
                <div><b>${labelType(e.type)}</b>${e.title?` – ${e.title}`:""}</div>
                <div class="muted">${fmtDateTime(e.eventStart)} • ${labelAnimals(state,e.animalIds)} ${e.fieldId ? "• " + fieldName(state,e.fieldId) : ""}</div>
              </div>`).join("")}
          </div>` : `<div class="muted">Ingen hendelser enda. Trykk +.</div>`}
      </div>
    </div>
  `);
  return {node, state};
}

function pageFlock(state, params){
  const group = params.get("group") || "LAM";
  const groups = ["ALLE","LAM","SOYE","VAER"];
  const animals = state.animals.filter(a=>a.status==="AKTIV").filter(a=>group==="ALLE" ? true : a.category===group);
  const missing = new Set(getMissingWeights(state,30).map(a=>a.id));
  const missingCount = animals.filter(a=>missing.has(a.id)).length;
  const q = group==="ALLE" ? "" : group;

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Flokk</div>
          <div class="muted">Rask registrering på gruppe</div>
        </div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="tabs">
        ${groups.map(g=>`<a class="tab ${g===group?'active':''}" href="#/flock?group=${g}">${g}</a>`).join("")}
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="h2">${group} – ${animals.length} aktive</div>
            <div class="muted">${missingCount} mangler vekt siste 30 dager</div>
          </div>
          <span class="badge">Massevalg</span>
        </div>
        <div class="space"></div>
        <div class="grid2">
          <a class="btn" href="#/log?new=WEIGHT&q=${encodeURIComponent(q)}&autoSelect=1">Registrer vekt</a>
          <a class="btn" href="#/log?new=TREATMENT&q=${encodeURIComponent(q)}&autoSelect=1">Registrer behandling</a>
          <a class="btn" href="#/log?new=MOVE&q=${encodeURIComponent(q)}&autoSelect=1">Registrer flytting</a>
          <a class="btn" href="#/log?new=NOTE&q=${encodeURIComponent(q)}&autoSelect=1">Registrer notat</a>
        </div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Liste (hurtig)</div>
        ${animals.length ? `<div class="list">
          ${animals.slice(0,80).map(a=>{
            const lw = getLastWeightKgForAnimal(state,a.id);
            const m = missing.has(a.id) ? " • ⚠️ mangler vekt" : "";
            return `
            <div class="item">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${a.tagNumber}</b> <span class="muted">(${a.category})</span></div>
                  <div class="muted">${a.birthYear}${lw?` • ${lw.kg} kg (${fmtDate(lw.at)})`:""}${m}</div>
                </div>
                <a class="badge" href="#/animals?id=${a.id}">Åpne</a>
              </div>
            </div>`;
          }).join("")}
        </div>` : `<div class="muted">Ingen dyr i denne gruppen.</div>`}
      </div>
    </div>
  `);
  return {node, state};
}

function pageInsights(state){
  const missW = getMissingWeights(state, 30);
  const od = overdueTasks(state);

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Innsikt</div>
          <div class="muted">Mangler data / oppfølging</div>
        </div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Dyr uten vekt siste 30 dager</div>
        ${missW.length ? `
          <div class="list">
            ${missW.slice(0,60).map(a=>`
              <div class="item">
                <div class="row" style="justify-content:space-between;">
                  <div><b>${a.tagNumber}</b> <span class="muted">(${a.category})</span></div>
                  <a class="badge" href="#/log?new=WEIGHT&animal=${a.id}">Registrer vekt</a>
                </div>
                <div class="muted small">${a.birthYear} • ${a.status}</div>
              </div>
            `).join("")}
          </div>` : `<div class="muted">Ingen mangler funnet.</div>`}
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Forfalte oppgaver</div>
        ${od.length ? `
          <div class="list">
            ${od.slice(0,60).map(t=>`
              <div class="item">
                <div class="row" style="justify-content:space-between;">
                  <div><b>${t.title}</b></div>
                  <div class="muted">${fmtDate(t.dueDate)}</div>
                </div>
              </div>
            `).join("")}
          </div>` : `<div class="muted">Ingen forfalte oppgaver.</div>`}
      </div>
    </div>
  `);

  return {node, state};
}

function pageAnimal

// ===== Step V3.75: Salg/Slakt (registrering + liste) =====
function pageSales

// ===== V3.75: UI Forventet lamming =====
function pageDue(state, params){
  const days = Number(params.get("days")||21);
  const list = getDueEwes(state, days);
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Forventet lamming</div><div class="muted">Neste ${days} dager</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>
      <div class="space"></div>
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <a class="badge" href="#/due?days=7">7</a>
          <a class="badge" href="#/due?days=14">14</a>
          <a class="badge" href="#/due?days=21">21</a>
          <a class="badge" href="#/due?days=30">30</a>
        </div>
        <a class="badge" href="javascript:void(0)" onclick="__genLambingTasks()">Lag oppgaver</a>
      </div>
      <div class="space"></div>
      ${list.length ? `
        <div class="list">
          ${list.map(x=>`
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${animalLabel(state,x.eweId)}</b></div>
                  <div class="muted">Forventet: ${fmtDate(x.due)}</div>
                </div>
                <div class="row">
                  <a class="badge" href="#/animal?id=${x.eweId}">Detalj</a>
                  <a class="badge" href="#/log?new=LAMB&animal=${x.eweId}">Lamming</a>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      ` : `<div class="card"><div class="muted">Ingen søyer med forventet lamming i dette vinduet.</div></div>`}
    </div>
  `);
  return {node, state};
}
(state, params){
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Salg / Slakt</div><div class="muted">Registrer og oversikt</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="grid2">
        <a class="btn" href="#/log?new=SALE">Registrer salg</a>
        <a class="btn" href="#/log?new=SLAUGHTER">Registrer slakt</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Historikk (siste 50)</div>
        ${state.events.filter(e=>!e.deletedAt && (e.type==="SALE"||e.type==="SLAUGHTER")).sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||"")).slice(0,50).map(e=>{
          const t = e.type==="SALE" ? "Salg" : "Slakt";
          const m = e.metadata||{};
          return `<div class="item"><div><b>${t}</b> • ${labelAnimals(state,e.animalIds)} ${m.price?`• ${m.price} kr`:""}</div><div class="muted">${fmtDateTime(e.eventStart)} ${m.buyer?`• ${m.buyer}`:""}</div></div>`;
        }).join("") || `<div class="muted">Ingen registreringer.</div>`}
      </div>
    </div>
  `);
  return {node, state};
}
s(state, params){
  const tab = params.get("tab") || "ALLE";
  const q = (params.get("q") || "").trim().toLowerCase();

  const animals = state.animals
    .filter(a => tab==="ALLE" ? true : a.category===tab)
    .filter(a => !q ? true : (`${a.tagNumber} ${a.birthYear} ${a.category} ${a.status}`).toLowerCase().includes(q))
    .sort((a,b)=> a.tagNumber.localeCompare(b.tagNumber));

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Dyr</div>
          <div class="muted">${state.animals.length} totalt</div>
        </div>
        <div class="row">
          <a class="badge" href="#/flock">Flokk</a>
          <a class="badge" href="#/animals?add=1">Legg til</a>
        </div>
      </div>

      <div class="space"></div>

      <div class="tabs">
        ${["ALLE","LAM","SOYE","VAER"].map(t=>`
          <a class="tab ${t===tab?'active':''}" href="#/animals?tab=${t}">${t}</a>
        `).join("")}
      </div>

      <div class="space"></div>

      <input class="input" placeholder="Søk (nummer/år/kategori/status)" value="${params.get("q")||""}" />

      <div class="space"></div>

      <div class="card">
        <div class="h2">Liste</div>
        ${animals.length ? `
          <div class="list">
            ${animals.map(a=>{
              const lw = getLastWeightKgForAnimal(state,a.id);
              return `
              <a class="item" style="text-decoration:none" href="#/animals?id=${a.id}">
                <div class="row">
                  <div>
                    <div><b>${a.tagNumber}</b> <span class="muted">(${a.category})</span></div>
                    <div class="muted">${a.birthYear} • ${a.status}${lw ? ` • sist vekt: ${lw.kg} kg (${fmtDate(lw.at)})` : ""}</div>
                  </div>
                  <div class="right badge">Åpne</div>
                </div>
              </a>`;
            }).join("")}
          </div>` : `<div class="muted">Ingen dyr enda.</div>`}
      </div>

      ${params.get("add")==="1" ? animalAddSheet() : ""}
    </div>
  `);

  const input = node.querySelector("input");
  input.addEventListener("input", (e)=>{
    const v = e.target.value;
    const p = new URLSearchParams(params);
    if(v) p.set("q", v); else p.delete("q");
    location.hash = `#/animals?${p.toString()}`;
  });

  return {node, state};
}

function animalAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/animals'"></div>
    <div class="sheet">
      <div class="h2">Legg til dyr</div>
      <label>Individnummer</label>
      <input id="an_tag" class="input" placeholder="f.eks 1456" />
      <div class="space"></div>
      <label>Kategori</label>
      <select id="an_cat" class="input">
        <option>LAM</option><option>SOYE</option><option>VAER</option>
      </select>
      <div class="space"></div>
      <label>Fødselsår</label>
      <input id="an_year" class="input" type="number" placeholder="2024" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addAnimal()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/animals">Avbryt</a>
    </div>
  `;
}

window.__addAnimal = function(){
  const state = loadState();
  const tag = document.querySelector("#an_tag").value.trim();
  const cat = document.querySelector("#an_cat").value;
  const year = Number(document.querySelector("#an_year").value);
  if(!tag || !year) { alert("Fyll ut individnummer og fødselsår"); return; }
  if(state.animals.some(a=>a.tagNumber===tag)) { alert("Individnummer finnes allerede"); return; }
  state.animals.push(newAnimal({tagNumber: tag, category: cat, birthYear: year}));
  saveState(state);
  nav("/animals");
};

function pageFields(state, params){
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Skifter</div>
          <div class="muted">${state.fields.length} totalt</div>
        </div>
        <a class="badge" href="#/fieldplans">Skifteplan</a>
            <a class="btn" href="#/reports">Rapporter</a>
        <a class="badge" href="#/fields?add=1">Legg til</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Liste</div>
        ${state.fields.length ? `<div class="list">
          ${state.fields.sort((a,b)=>a.name.localeCompare(b.name)).map(f=>`
            <div class="item">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${f.name}</b></div>
                  <div class="muted">${f.areaDaa} daa • ${f.active ? "Aktiv":"Arkivert"}</div>
                </div>
                <a class="badge" href="#/fields?editCrop=${f.id}">Endre kultur</a>
                <a class="badge" href="#/fieldplan?field=${f.id}">Plan</a>
                <a class="badge" href="#/log?field=${f.id}">Logg</a>
              </div>
            </div>`).join("")}
        </div>` : `<div class="muted">Ingen skifter enda.</div>`}
      </div>

      ${params.get("add")==="1" ? fieldAddSheet() : ""}
    </div>
  `);
  return {node, state};
}


function fieldCropSheet(state, fieldId){
  const f = state.fields.find(x=>x.id===fieldId);
  if(!f) return "";
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/fields'"></div>
    <div class="sheet">
      <div class="h2">Endre kultur</div>
      <div class="muted">${f.name}</div>
      <div class="space"></div>
      <label>Kultur</label>
      <select id="fc_crop" class="input">
        ${Object.keys(N_NORMS).map(k=>`<option value="${k}" ${k===f.crop?"selected":""}>${k}</option>`).join("")}
      </select>
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__saveFieldCrop('${fieldId}')">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/fields">Lukk</a>
    </div>
  `;
}
window.__saveFieldCrop = function(fieldId){
  const state = loadState();
  const f = state.fields.find(x=>x.id===fieldId);
  if(!f) return;
  f.crop = document.querySelector("#fc_crop")?.value || f.crop || "GROVFOR";
  saveState(state);
  nav("/fields");
};

function fieldAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/fields'"></div>
    <div class="sheet">
      <div class="h2">Legg til skifte</div>
      <label>Navn</label>
      <input id="fi_name" class="input" placeholder="Skifte 1" />
      <div class="space"></div>
      <label>Areal (daa)</label>
      <input id="fi_area" class="input" type="number" placeholder="12" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addField()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/fields">Avbryt</a>
    </div>
  `;
}

window.__addField = function(){
  const state = loadState();
  const name = document.querySelector("#fi_name").value.trim();
  const area = Number(document.querySelector("#fi_area").value);
  if(!name || !area) { alert("Fyll ut navn og areal"); return; }
  if(state.fields.some(f=>f.name.toLowerCase()===name.toLowerCase())) { alert("Skifte finnes allerede"); return; }
  const crop = document.querySelector("#fi_crop")?.value || "GROVFOR";
  state.fields.push(newField({name, areaDaa: area, crop}));
  saveState(state);
  nav("/fields");
};

function pageLog(state, params){
  const creating = params.get("new");
  const filterField = params.get("field");
  const viewId = params.get("view");
  const batch = params.get("batch")==="1";

  const events = state.events.filter(e=>!e.deletedAt).filter(e=> filterField ? e.fieldId===filterField : true)
    .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""));

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Logg</div>
          <div class="muted">${filterField ? ("Filtrert: " + fieldName(state, filterField)) : "Siste hendelser"}</div>
        </div>
        <a class="badge" href="#/log?batch=1">Batch journal</a>
          <a class="badge" href="#/quick">+</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Hendelser</div>
        ${events.length ? `<div class="list">
          ${events.slice(0,40).map(e=>{
            const w = kslWarningsForEvent(state,e);
            return `
            <div class="item">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${labelType(e.type)}</b>${e.title?` – ${e.title}`:""}</div>
                  <div class="muted">${fmtDateTime(e.eventStart)} • ${labelAnimals(state, e.animalIds)} ${e.fieldId ? "• " + fieldName(state,e.fieldId) : ""}</div>
                  ${w.length ? `<div class="muted small">⚠️ ${w.join(" ")}</div>` : ``}
                </div>
                <div class="row">
                  <a class="badge" href="#/log?view=${e.id}">Åpne</a>
                  <a class="badge" href="javascript:void(0)" onclick="__deleteEvent('${e.id}')">Slett</a>
                </div>
              </div>
            </div>`;
          }).join("")}
        </div>` : `<div class="muted">Ingen hendelser enda.</div>`}
      </div>

      ${viewId ? eventDetailSheet(state, viewId) : ""}
      ${creating ? eventCreateSheet(state, creating) : ""}
      ${batch ? batchSheet(state) : ""}
    </div>
  `);
  return {node, state};
}

window.__deleteEvent = function(eventId){

  const state0 = loadState();
  ensureLocks(state0);
  const ev = (state0.events||[]).find(e=>e.id===id);
  const iso = ev?.eventStart || "";
  if(iso && !canEditEventDate(state0, iso)){
    alert("Dette året er låst i Arkiv. Åpne året først for å slette.");
    return;
  }


  const ok = confirm("Er du sikker på at du vil slette denne registreringen?");
  if(!ok) return;
  const state = loadState();
  softDeleteEvent(state, eventId);
  saveState(state);
  render();
};

function eventDetailSheet(state, eventId){
  const ev = state.events.find(e=>e.id===eventId && !e.deletedAt);
  if(!ev) return "";
  const warns = kslWarningsForEvent(state, ev);
  let journalText = null;
  if(ev.type==="SPRAY") journalText = sprayJournal(state, ev);
  if(ev.type==="FERTILIZE") journalText = fertilizeJournal(state, ev);

  return `
    <div class="sheet-backdrop" onclick="location.hash='#/log'"></div>
    <div class="sheet">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h2">${labelType(ev.type)}${ev.title ? ` – ${ev.title}` : ""}</div>
          <div class="muted">${fmtDateTime(ev.eventStart)} • ${labelAnimals(state, ev.animalIds)} ${ev.fieldId ? "• " + fieldName(state, ev.fieldId) : ""}</div>
        </div>
        <span class="badge">${warns.length ? "⚠️" : "OK"}</span>
      </div>

      ${warns.length ? `
        <div class="space"></div>
        <div class="card warn">
          <div class="h2">Varsler (KSL)</div>
          <div class="muted">${warns.join(" ")}</div>
        </div>
      ` : ``}

      ${type==="WEAN" ? `
        <div class="space"></div>
        <div class="card">
          <div class="h2">Avvenning</div>
          <label>Notat</label>
          <input id="ev_wean_note" class="input" placeholder="f.eks. avvent, flyttet" />
        </div>
      ` : ``}

      ${journalText ? `
        <div class="space"></div>
        <div class="card">
          <div class="h2">Journal</div>
          <textarea class="input mono" readonly>${journalText}</textarea>
          <div class="space"></div>
          <div class="grid2">
            <a class="btn" href="javascript:void(0)" onclick="__copyJournal('${eventId}')">Kopier</a>
            <a class="btn" href="javascript:void(0)" onclick="__downloadJournal('${eventId}')">Last ned .txt</a>
          </div>
        </div>
      ` : ``}

      <div class="space"></div>
      <a class="btn" href="#/log">Lukk</a>
    </div>
  `;
}

window.__copyJournal = function(eventId){
  const state = loadState();
  const ev = state.events.find(e=>e.id===eventId);
  if(!ev) return;
  let t = "";
  if(ev.type==="SPRAY") t = sprayJournal(state, ev);
  if(ev.type==="FERTILIZE") t = fertilizeJournal(state, ev);
  if(!t) return;
  copyToClipboard(t);
};

window.__downloadJournal = function(eventId){
  const state = loadState();
  const ev = state.events.find(e=>e.id===eventId);
  if(!ev) return;
  let t = "";
  let name = "journal.txt";
  if(ev.type==="SPRAY"){ t = sprayJournal(state, ev); name = `sprøytejournal_${fmtDate(ev.eventStart)}.txt`; }
  if(ev.type==="FERTILIZE"){ t = fertilizeJournal(state, ev); name = `gjødseljournal_${fmtDate(ev.eventStart)}.txt`; }
  if(!t) return;
  const blob = new Blob([t], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name.replaceAll("/","-");
  document.body.appendChild(a);
  a.click();
  a.remove();
};


function batchSheet(state){
  const eligible = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="SPRAY" || e.type==="FERTILIZE").sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||"")).slice(0,100);
  const fromDefault = new Date(Date.now()-30*24*60*60*1000);
  const toDefault = new Date();
  const fromVal = `${fromDefault.getFullYear()}-${pad(fromDefault.getMonth()+1)}-${pad(fromDefault.getDate())}`;
  const toVal = `${toDefault.getFullYear()}-${pad(toDefault.getMonth()+1)}-${pad(toDefault.getDate())}`;

  return `
    <div class="sheet-backdrop" onclick="location.hash='#/log'"></div>
    <div class="sheet">
      <div class="h2">Batch journal</div>
      <div class="muted">Lager én .txt med alle sprøyte-/gjødseljournaler i periode.</div>

      <div class="space"></div>

      <label>Fra</label>
      <input id="bj_from" class="input" type="date" value="${fromVal}" />
      <div class="space"></div>
      <label>Til</label>
      <input id="bj_to" class="input" type="date" value="${toVal}" />

      <div class="space"></div>

      <div class="card">
        <div class="h2">Tilgjengelige hendelser (maks 100)</div>
        <div class="muted small">Sprøyting/Gjødsling: ${eligible.length} funnet (nyeste først).</div>
      </div>

      <div class="space"></div>

      <a class="btn primary" href="javascript:void(0)" onclick="__downloadBatch()">Last ned samlet .txt</a>
      <div class="space"></div>
      <a class="btn" href="#/log">Lukk</a>
    </div>
  `;
}

window.__downloadBatch = function(){
  const state = loadState();
  const from = document.querySelector("#bj_from").value;
  const to = document.querySelector("#bj_to").value;
  if(!from || !to){ alert("Velg fra/til"); return; }
  const fromISO = new Date(from+"T00:00:00").toISOString();
  const toISO = new Date(to+"T23:59:59").toISOString();

  const events = state.events
    .filter(e=>!e.deletedAt)
    .filter(e=> (e.type==="SPRAY" || e.type==="FERTILIZE"))
    .filter(e=> (e.eventStart||"") >= fromISO && (e.eventStart||"") <= toISO )
    .sort((a,b)=> (a.eventStart||"").localeCompare(b.eventStart||""));

  if(!events.length){ alert("Ingen journaler i perioden"); return; }

  const parts = [];
  for(const ev of events){
    const j = journalFor(state, ev);
    if(!j) continue;
    parts.push("=".repeat(60));
    parts.push(`${labelType(ev.type)} • ${fmtDateTime(ev.eventStart)} • ${ev.title||""}`);
    parts.push("-".repeat(60));
    parts.push(j);
    parts.push("");
  }

  const filename = `farmapp_batch_journal_${from}_til_${to}.txt`;
  downloadText(filename, parts.join("\\n"));
};

function eventCreateSheet(state, type){
  // type is string like WEIGHT etc
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/log'"></div>
    <div class="sheet">
      <div class="h2">${labelType(type)}</div>
      <label>Dato/tid</label>
      <input id="ev_dt" class="input" type="datetime-local" />
      <div class="space"></div>

      <label>Velg dyr (massevalg)</label>
      <input id="ev_q" class="input" placeholder="Søk dyr (nr/år/kategori)" />
      <div class="space"></div>

      <div class="row">
        <span class="pill" id="ev_sel">Valgt: 0</span>
        <a class="badge right" href="javascript:void(0)" onclick="__selectAllFiltered()">Velg alle filtrerte</a>
        <a class="badge" href="javascript:void(0)" onclick="__clearSelected()">Nullstill</a>
      </div>

      <div class="space"></div>
      <div class="card" style="max-height:220px;overflow:auto" id="ev_list"></div>

      <div class="space"></div>
      <label>Skifte ${(type==="SPRAY"||type==="FERTILIZE"||type==="MOVE") ? "(påkrevd)" : "(valgfritt)"}</label>
      <select id="ev_field" class="input">
        <option value="">—</option>
        ${state.fields.filter(f=>f.active).sort((a,b)=>a.name.localeCompare(b.name)).map(f=>`<option value="${f.id}">${f.name}</option>`).join("")}
      </select>

      <div class="space"></div>

      ${type==="TREATMENT" ? `
        <label>Medisin</label>
        <input id="ev_med" class="input" placeholder="f.eks Ormekur" />
        <div class="space"></div>
        <label>Dose (valgfritt)</label>
        <input id="ev_dose" class="input" placeholder="f.eks 10 ml" />
        <div class="space"></div>
      ` : ``}

      ${type==="WEIGHT" ? `
        <label>Vekt (kg)</label>
        <input id="ev_kg" class="input" type="number" step="0.1" placeholder="f.eks 42.5" />
        <div class="space"></div>
      ` : ``}

      ${type==="NOTE" ? `
        <label>Notat</label>
        <textarea id="ev_note" class="input" placeholder="Skriv notat…"></textarea>
        <div class="space"></div>
      ` : ``}

      ${type==="SPRAY" ? `
        <label>Middel (produkt)</label>
        <input id="ev_product" class="input" placeholder="f.eks middelnavn" />
        <div class="space"></div>
        <label>Dose</label>
        <input id="ev_dose2" class="input" placeholder="f.eks 0,5 l/daa" />
        <div class="space"></div>
        <label>Vannmengde (valgfritt)</label>
        <input id="ev_water" class="input" placeholder="f.eks 20 l/daa" />
        <div class="space"></div>
        <label>Utførende</label>
        <input id="ev_operator" class="input" placeholder="Navn" />
        <div class="space"></div>
        <label>Vær (valgfritt)</label>
        <input id="ev_weather" class="input" placeholder="f.eks lett bris, tørt" />
        <div class="space"></div>
        <label>Formål</label>
        <input id="ev_reason" class="input" placeholder="f.eks ugraskontroll" />
        <div class="space"></div>
      ` : ``}

      
      ${type==="HEALTH" ? `

      ${type==="MATE" ? `
        <div class="space"></div>
        <div class="card">
          <div class="h2">Paring</div>
          <label>Paringsvær (valg)</label>
          <select id="ev_mate_sire" class="input">
            <option value="">Velg…</option>
            ${state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="V").sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||"")).map(a=>`<option value="${a.id}">${a.tagId||"—"} ${a.name||""}</option>`).join("")}
          </select>
          <div class="space"></div>
          <label>Notat</label>
          <input id="ev_mate_note" class="input" placeholder="f.eks. sluppet inn på beite" />
        </div>
      ` : ``}

      ${type==="SCAN" ? `
        <div class="space"></div>
        <div class="card">
          <div class="h2">Ultralyd</div>
          <label>Antall foster</label>
          <input id="ev_scan_fetuses" class="input" type="number" placeholder="2" />
          <div class="space"></div>
          <label>Notat</label>
          <input id="ev_scan_note" class="input" placeholder="f.eks. usikker" />
        </div>
      ` : ``}

      ${type==="LAMB" ? `
        <div class="space"></div>
        <div class="card">
          <div class="h2">Lamming</div>
          <label>Lam (ørenr, kommaseparert)</label>
          <input id="ev_lamb_tags" class="input" placeholder="NO123, NO124" />
          <div class="space"></div>
          <label>Antall dødfødte</label>
          <input id="ev_lamb_still" class="input" type="number" placeholder="0" />
          <div class="space"></div>
          <label>Vansker</label>
          <select id="ev_lamb_difficulty" class="input">
            <option value="INGEN">Ingen</option>
            <option value="LITT">Litt</option>
            <option value="MYE">Mye</option>
          </select>
          <div class="space"></div>
          <label>Notat</label>
          <input id="ev_lamb_note" class="input" placeholder="tilstand, hjelp, råmjølk..." />
        </div>
      ` : ``}

        <div class="space"></div>
        <div class="card">
          <div class="h2">Behandling</div>
          <label>Type</label>
          <select id="ev_health_kind" class="input">
            <option value="MEDISIN">Medisin</option>
            <option value="ORMEKUR">Ormekur</option>
            <option value="VAKSINE">Vaksine</option>
            <option value="ANNET">Annet</option>
          </select>
          <div class="space"></div>
          <label>Preparat</label>
          <select id="ev_health_med" class="input">
            <option value="">Velg fra lager…</option>
            ${(() => { ensureMeds(state); return state.meds.filter(m=>m.active).map(m=>`<option value="${m.id}">${m.name}</option>`).join(""); })()}
          </select>
          <div class="space"></div>
          <label>Preparat (fri tekst)</label>
          <input id="ev_health_product" class="input" placeholder="Ivomec / Zinco..." />
          <div class="space"></div>
          <label>Dosering</label>
          <input id="ev_health_dose" class="input" placeholder="ml pr dyr / mg/kg" />
          <div class="space"></div>
          <label>Tilbakehold (dager)</label>
          <input id="ev_health_withdraw" class="input" type="number" placeholder="0" />
          <div class="space"></div>
          <label>Veterinær (valgfritt)</label>
          <input id="ev_health_vet" class="input" placeholder="Navn" />
        </div>
      ` : ``}

${type==="FERTILIZE" ? `
        <label>Type</label>
        <select id="ev_kind" class="input">
          <option value="">Velg…</option>
          <option value="HUSDYR">Husdyrgjødsel</option>
          <option value="MINERAL">Mineralgjødsel</option>
        </select>
        <div class="space"></div>
        <label>Mengde</label>
        <input id="ev_amount" class="input" placeholder="f.eks 3 tonn / 25 kg/daa" />
        <div class="space"></div>
        <div id="fert_extra"></div>
      ` : ``}

      <label>Kommentar (valgfritt)</label>
      <textarea id="ev_desc" class="input" placeholder="Valgfritt"></textarea>
      <div class="space"></div>

      <a class="btn primary" href="javascript:void(0)" onclick="__saveEvent('${type}')">Lagre (umiddelbart)</a>
      <div class="space"></div>
      <a class="btn" href="#/log">Avbryt</a>
    </div>
  `;
}

let __evSelected = new Set();
let __evFiltered = [];

function initEventSheet(presetQuery, autoSelect){
  document.querySelector("#ev_dt").value = toDateTimeLocal(new Date().toISOString());
  __evSelected = new Set();

  const qInput = document.querySelector("#ev_q");
  if(presetQuery){ qInput.value = presetQuery; }
  qInput.addEventListener("input", ()=> updateAnimalPickList(qInput.value));

  const kind = document.querySelector("#ev_kind");
  if(kind){
    kind.addEventListener("change", ()=>{
      const v = kind.value;
      const extra = document.querySelector("#fert_extra");
      if(!extra) return;
      if(v==="MINERAL"){
        extra.innerHTML = `
          <label>NPK (valgfritt)</label>
          <input id="ev_npk" class="input" placeholder="f.eks 27-4-4" />
          <div class="space"></div>
        `;
      } else if(v==="HUSDYR"){
        extra.innerHTML = `
          <label>Gjødselverdier (valgfritt)</label>
          <input id="ev_values" class="input" placeholder="f.eks N=3, P=0,7, K=2,5" />
          <div class="space"></div>
        `;
      } else { extra.innerHTML = ``; }
    });
  }

  updateAnimalPickList(qInput.value);
  if(autoSelect) __selectAllFiltered();
}

function updateAnimalPickList(q){
  const state = loadState();
  const s = (q||"").trim().toLowerCase();
  __evFiltered = state.animals.filter(a=>a.status==="AKTIV").filter(a=> !s ? true : (`${a.tagNumber} ${a.birthYear} ${a.category}`).toLowerCase().includes(s))
    .sort((a,b)=> a.tagNumber.localeCompare(b.tagNumber));

  const list = document.querySelector("#ev_list");
  list.innerHTML = __evFiltered.length ? __evFiltered.map(a=>{
    const checked = __evSelected.has(a.id) ? "checked" : "";
    return `
      <label class="row item" style="border:0;padding:8px 0">
        <input type="checkbox" ${checked} onchange="__toggleAnimal('${a.id}')" />
        <div>
          <div><b>${a.tagNumber}</b> <span class="muted">(${a.category})</span></div>
          <div class="muted">${a.birthYear}</div>
        </div>
      </label>
    `;
  }).join("") : `<div class="muted">Ingen dyr matcher søket.</div>`;
  updateSelectedBadge();
}

window.__toggleAnimal = function(id){
  if(__evSelected.has(id)) __evSelected.delete(id); else __evSelected.add(id);
  updateSelectedBadge();
};

function __selectAllFiltered(){
  for(const a of __evFiltered) __evSelected.add(a.id);
  updateAnimalPickList(document.querySelector("#ev_q").value);
}
window.__selectAllFiltered = __selectAllFiltered;

window.__clearSelected = function(){
  __evSelected = new Set();
  updateAnimalPickList(document.querySelector("#ev_q").value);
};

function updateSelectedBadge(){
  const el = document.querySelector("#ev_sel");
  if(el) el.textContent = `Valgt: ${__evSelected.size}`;
}


window.__quickFieldEvent = function(type, fieldId){
  const state = loadState();
  // store template in sessionStorage for one-time prefill
  const payload = { type, fieldId, at: nowISO() };
  if(type==="SPRAY") payload.template = getLastSprayTemplate(state);
  if(type==="FERTILIZE") payload.template = getLastFertTemplate(state);
  sessionStorage.setItem("farmapp_prefill", JSON.stringify(payload));
  nav(`/log?new=${type}&field=${fieldId}&prefill=1`);
};

window.__saveEvent = function(type){

  const state0 = loadState();
  ensureLocks(state0);
  const dt = (document.querySelector("#ev_date")?.value || "").trim();
  const iso = dt ? (dt+"T12:00:00.000Z") : (document.querySelector("#ev_start")?.value||"");
  if(iso && !canEditEventDate(state0, iso)){
    alert("Dette året er låst i Arkiv. Åpne året først for å gjøre endringer.");
    return;
  }


  const state = loadState();
  const dt = document.querySelector("#ev_dt").value;
  const eventStart = dt ? new Date(dt).toISOString() : nowISO();
  const fieldId = document.querySelector("#ev_field")?.value || null;
  const desc = document.querySelector("#ev_desc").value.trim();
  const animalIds = Array.from(__evSelected);

  const requireField = (type==="MOVE"||type==="SPRAY"||type==="FERTILIZE");
  if(requireField && !fieldId){ alert("Velg skifte"); return; }

  const metadata = {};
  let title = "";

  if(type==="TREATMENT"){
    const med = (document.querySelector("#ev_med").value||"").trim();
    const dose = (document.querySelector("#ev_dose").value||"").trim();
    if(!med){ alert("Skriv inn medisin"); return; }
    metadata.medicine = med; if(dose) metadata.dose = dose;
    title = dose ? `${med} (${dose})` : med;
  }
  if(type==="WEIGHT"){
    const kg = Number(document.querySelector("#ev_kg").value);
    if(!kg || kg<=0){ alert("Skriv inn vekt (kg)"); return; }
    metadata.kg = kg; title = `${kg} kg`;
  }
  if(type==="MOVE"){ title = `Flyttet til ${fieldName(state, fieldId)}`; }
  if(type==="NOTE"){
    const note = (document.querySelector("#ev_note").value||"").trim();
    if(!note){ alert("Skriv notat"); return; }
    metadata.note = note; title = note.length>40 ? note.slice(0,40)+"…" : note;
  }
  if(type==="SPRAY"){
    const product = (document.querySelector("#ev_product").value||"").trim();
    const dose = (document.querySelector("#ev_dose2").value||"").trim();
    const water = (document.querySelector("#ev_water").value||"").trim();
    const operator = (document.querySelector("#ev_operator").value||"").trim();
    const weather = (document.querySelector("#ev_weather").value||"").trim();
    const reason = (document.querySelector("#ev_reason").value||"").trim();
    if(!product || !dose || !operator || !reason){ alert("Fyll ut produkt, dose, utførende og formål"); return; }
    Object.assign(metadata,{ product, dose, water, operator, weather, reason });
    title = `${product} – ${dose}`;
  }
  if(type==="FERTILIZE"){
    const kind = (document.querySelector("#ev_kind").value||"").trim();
    const amount = (document.querySelector("#ev_amount").value||"").trim();
    if(!kind || !amount){ alert("Velg type og skriv mengde"); return; }
    metadata.kind = kind; metadata.amount = amount;
    if(kind==="MINERAL"){
      metadata.npk = (document.querySelector("#ev_npk")?.value||"").trim();
      title = `Mineral – ${amount}${metadata.npk?` (NPK ${metadata.npk})`:""}`;
    } else {
      metadata.values = (document.querySelector("#ev_values")?.value||"").trim();
      title = `Husdyr – ${amount}`;
    }
  }

  state.events.push(newEvent({type, animalIds, fieldId, title, description: desc, metadata, eventStart}));
  saveState(state);
  nav("/log");
};

function pageTasks

// ===== V2.96: Dokumentregister =====
function ensureDocuments

// ===== V3.75: Kontaktregister =====
function ensureContacts

// ===== V3.75: Arbeidslogg =====
function ensureWorkLog

// ===== V3.75: Kostnader =====
function ensureCosts

// ===== V3.75: Inntekter =====
function ensureIncome

// ===== V3.66: Budsjett =====
function ensureBudget

// ===== V3.67: Budsjett-side =====
function pageBudget(state){
  ensureBudget(state);
  const budget=(state.budget||[])[0]?.amount||0;
  const node=h(`
    <div class="container">
      <div class="h1">Budsjett</div>
      <div class="space"></div>
      <div class="card">Budsjett: <b>${budget.toFixed(2)}</b></div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__setBudget()">Sett budsjett</a>
    </div>
  `);
  return {node,state};
}
window.__setBudget=function(){
  const state=loadState();
  const amount=prompt("Årsbudsjett")||0;
  setBudget(state,amount);
  saveState(state);
  nav("/budget");
};
(state){
  if(!Array.isArray(state.budget)) state.budget=[];
}
function setBudget(state,amount){
  ensureBudget(state);
  state.budget=[{amount:Number(amount)||0, updatedAt:nowISO()}];
}


// ===== V3.75: Resultat =====
function netResult

// ===== V3.68: Budsjettavvik =====
function budgetDeviation

// ===== V3.70: Har budsjett =====
function hasBudget(state){
  return (state.budget||[]).length>0;
}
(state){
  const budget=(state.budget||[])[0]?.amount||0;
  return netResult(state)-budget;
}


// ===== V3.75: Resultatprosent =====
function profitMargin(state){
  const inc=(state.income||[]).reduce((s,i)=>s+i.amount,0);
  if(!inc) return null;
  return (netResult(state)/inc)*100;
}
(state){
  const inc=(state.income||[]).reduce((s,i)=>s+i.amount,0);
  const cost=(state.costs||[]).reduce((s,c)=>s+c.amount,0);
  return inc-cost;
}


// ===== V3.75: Inntekter-side =====
function pageIncome(state){
  ensureIncome(state);
  const total=(state.income||[]).reduce((s,i)=>s+i.amount,0);
  const rows=(state.income||[]).slice().reverse().map(i=>`
    <div class="card">
      <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div><b>${i.date}</b> • ${i.amount}</div>
        <a class="badge" href="javascript:void(0)" onclick="__delIncome('${i.id}')">Slett</a>
      </div>
      <div class="muted">${i.desc||""}</div>
    </div>
  `).join("");
  const node=h(`
    <div class="container">
      <div class="h1">Inntekter</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addIncome()">Ny inntekt</a>
      <div class="space"></div>
      <div class="card">Sum inntekter: <b>${total.toFixed(2)}</b></div>
      <div class="space"></div>
      ${rows || `<div class="card"><div class="muted">Ingen inntekter registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addIncome=function

// ===== V3.75: Slett inntekt =====
window.__delIncome=function(id){
  if(!confirm("Slette inntekten?")) return;
  const state=loadState();
  ensureIncome(state);
  state.income = (state.income||[]).filter(i=>i.id!==id);
  if(typeof logAudit==="function") logAudit(state,"Inntekt slettet");
  saveState(state);
  nav("/income");
};
(){
  const state=loadState();
  const desc=prompt("Beskrivelse");
  if(!desc) return;
  const amount=prompt("Beløp")||0;
  addIncome(state,desc,amount);
  saveState(state);
  nav("/income");
};
(state){
  if(!Array.isArray(state.income)) state.income=[];
}
function addIncome(state,desc,amount){
  ensureIncome(state);
  state.income.push({id:uid(), desc, amount:Number(amount)||0, date:nowISO().slice(0,10)});
}


// ===== V3.75: Arbeidsregistreringer =====
function workEntryCount(state){
  return (state.workLog||[]).length;
}


// ===== V3.75: Kostnader =====
function pageCosts(state){
  ensureCosts(state);
  const total=(state.costs||[]).reduce((s,c)=>s+c.amount,0);
  const node=h(`
    <div class="container">
      <div class="h1">Kostnader</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addCost()">Ny kostnad</a>
      <div class="space"></div>
      <div class="card">Sum kostnader: <b>${total.toFixed(2)}</b></div>
      <div class="space"></div>
      ${(state.costs||[]).map(c=>`
        <div class="card">
          <div><b>${c.date}</b> • ${c.amount}</div>
          <div class="muted">${c.desc||""}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen kostnader registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addCost=function(){
  const state=loadState();
  const desc=prompt("Beskrivelse");
  if(!desc) return;
  const amount=prompt("Beløp")||0;
  addCost(state,desc,amount);
  saveState(state);
  nav("/costs");
};
(state){
  if(!Array.isArray(state.costs)) state.costs=[];
}
function addCost(state,desc,amount){
  ensureCosts(state);
  state.costs.push({id:uid(), desc, amount:Number(amount)||0, date:nowISO().slice(0,10)});
}


// ===== V3.75: Arbeid =====
function pageWorkLog(state){
  ensureWorkLog(state);
  const total=(state.workLog||[]).reduce((s,w)=>s+w.hours,0);
  const node=h(`
    <div class="container">
      <div class="h1">Arbeid</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addWork()">Ny registrering</a>
      <div class="space"></div>
      <div class="card">Timer totalt: <b>${total.toFixed(1)}</b></div>
      <div class="space"></div>
      ${(state.workLog||[]).map(w=>`
        <div class="card">
          <div><b>${w.date}</b> • ${w.hours} t</div>
          <div class="muted">${w.text||""}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen arbeid registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addWork=function(){
  const state=loadState();
  const text=prompt("Beskrivelse");
  if(!text) return;
  const hours=prompt("Timer")||0;
  addWorkLog(state,text,hours);
  saveState(state);
  nav("/work");
};
(state){
  if(!Array.isArray(state.workLog)) state.workLog=[];
}
function addWorkLog(state,text,hours){
  ensureWorkLog(state);
  state.workLog.push({id:uid(), text, hours:Number(hours)||0, date:nowISO().slice(0,10)});
}


// ===== V3.75: Kontakter =====
function pageContacts(state){
  ensureContacts(state);
  const node=h(`
    <div class="container">
      <div class="h1">Kontakter</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addContact()">Ny kontakt</a>
      <div class="space"></div>
      ${(state.contacts||[]).map(c=>`
        <div class="card"><b>${c.name}</b> • ${c.phone||""}</div>
      `).join("") || `<div class="card"><div class="muted">Ingen kontakter.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addContact=function(){
  const state=loadState();
  const name=prompt("Navn");
  if(!name) return;
  const phone=prompt("Telefon")||"";
  addContact(state,name,phone);
  saveState(state);
  nav("/contacts");
};
(state){
  if(!Array.isArray(state.contacts)) state.contacts=[];
}
function addContact(state,name,phone){
  ensureContacts(state);
  state.contacts.push({id:uid(), name, phone, createdAt:nowISO()});
}


// ===== V2.98: Medisinlager =====
function ensureMedInventory

// ===== V3.75: Dokument KPI =====
function documentCount

// ===== V3.75: Event KPI =====
function eventCount

// ===== V3.75: Antall aktive varsler =====
function triggeredRulesCount(state){
  const rules=ensureRules(state)||[];
  let total=0;
  for(const r of rules){
    const res=r.run(state)||[];
    total+=res.length;
  }
  return total;
}
(state){
  return (state.events||[]).filter(e=>!e.deletedAt).length;
}
(state){
  return (state.documents||[]).length;
}


// ===== V2.99: Medisinlager-side =====
function pageMedInventory(state){
  ensureMedInventory(state);
  const node=h(`
    <div class="container">
      <div class="h1">Medisinlager</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addMed()">Legg til medisin</a>
      <div class="space"></div>
      ${(state.medInventory||[]).map(m=>`
        <div class="card">
          <div><b>${m.name}</b> • ${m.amount} stk</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen medisiner registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addMed=function(){
  const state=loadState();
  const name=prompt("Medisinnavn");
  if(!name) return;
  const amount=prompt("Antall")||0;
  addMedication(state,name,amount);
  saveState(state);
  nav("/med");
};
(state){
  if(!Array.isArray(state.medInventory)) state.medInventory=[];
}
function addMedication(state,name,amount){
  ensureMedInventory(state);
  state.medInventory.push({id:uid(), name, amount:Number(amount)||0, createdAt:nowISO()});
}


// ===== V2.97: Dokumentoversikt =====
function pageDocuments(state){
  ensureDocuments(state);
  const node=h(`
    <div class="container">
      <div class="h1">Dokumenter</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__addDoc()">Legg til dokument</a>
      <div class="space"></div>
      ${(state.documents||[]).map(d=>`
        <div class="card">
          <div><b>${d.name}</b> • ${d.type}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen dokument registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
window.__addDoc=function(){
  const state=loadState();
  const name=prompt("Dokumentnavn");
  if(!name) return;
  const type=prompt("Type (f.eks KSL, Veterinær, Avtale)")||"";
  addDocument(state,name,type);
  saveState(state);
  nav("/documents");
};
(state){
  if(!Array.isArray(state.documents)) state.documents=[];
}
function addDocument(state,name,type){
  ensureDocuments(state);
  state.documents.push({id:uid(), name, type, createdAt:nowISO()});
}
(state, params){
  const creating = params.get("new")==="1";
  const tasks = state.tasks.slice().sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Oppgaver</div><div class="muted">Enkel planlegging</div></div>
        <a class="badge" href="#/tasks?new=1">Legg til</a>
      </div>
      <div class="space"></div>
      <div class="card">
        <div class="h2">Liste</div>
        ${tasks.length ? `<div class="list">
          ${tasks.map(t=>`
            <div class="item">
              <div class="row" style="justify-content:space-between;">
                <div><div><b>${t.title}</b>${t.completed ? " ✅" : ""}</div><div class="muted">${fmtDate(t.dueDate)}</div></div>
                <a class="badge" href="javascript:void(0)" onclick="__toggleTask('${t.id}')">${t.completed ? "Åpne" : "Fullfør"}</a>
              </div>
              ${(t.meta && t.meta.fieldId) ? `<div class="muted small">Skifte: ${fieldName(loadState(), t.meta.fieldId)} • År: ${t.meta.year||""}</div>` : ``}
              ${t.description ? `<div class="muted small">${t.description}</div>` : ``}
            </div>`).join("")}
        </div>` : `<div class="muted">Ingen oppgaver enda.</div>`}
      </div>
      ${creating ? taskCreateSheet(state) : ""}
    </div>
  `);
  return {node, state};
}
window.__toggleTask = function(id){
  const state = loadState(); const t = state.tasks.find(x=>x.id===id);
  if(!t) return; t.completed = !t.completed; saveState(state); render();
};
function taskCreateSheet(state){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/tasks'"></div>
    <div class="sheet">
      <div class="h2">Ny oppgave</div>
      <label>Tittel</label><input id="ta_title" class="input" placeholder="f.eks Ormekur lam" />
      <div class="space"></div>
      <label>Dato</label><input id="ta_date" class="input" type="date" />
      <div class="space"></div>
      <label>Kommentar</label><textarea id="ta_desc" class="input" placeholder="Valgfritt"></textarea>
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__saveTask()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/tasks">Avbryt</a>
    </div>
  `;
}
window.__saveTask = function(){
  const state = loadState();
  const title = document.querySelector("#ta_title").value.trim();
  const d = document.querySelector("#ta_date").value;
  if(!title || !d){ alert("Fyll ut tittel og dato"); return; }
  const dueDate = new Date(d + "T09:00:00").toISOString();
  const desc = document.querySelector("#ta_desc").value.trim();
  const r = route();
  const fieldId = r.params.get("field");
  const animal = r.params.get("animal");
  const year = r.params.get("year");
  const meta = {};
  if(fieldId) meta.fieldId = fieldId;
  if(year) meta.year = Number(year);
  if(animal) meta.animalId = animal;
  state.tasks.push(newTask({title, dueDate, description: desc, meta}));
  saveState(state); nav("/tasks");
};

function pageWork(state){
  const running = state.work.running;
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Leiekjøring</div><div class="muted">Start/stopp • lagres som hendelse</div></div>
        <a class="badge" href="#/settings">Backup</a>
      </div>
      <div class="space"></div>
      <div class="card">
        ${running ? `
          <div class="h2">Pågående jobb</div>
          <div class="muted">Startet: ${fmtDateTime(running.startedAt)}</div>
          <div class="space"></div>
          <div class="pill mono" id="wo_timer">00:00</div>
          <div class="space"></div>
          <a class="btn danger" href="javascript:void(0)" onclick="__stopWork()">Stopp</a>
        ` : `
          <div class="h2">Start jobb</div>
          <label>Kunde</label><input id="wo_customer" class="input" placeholder="f.eks Ola Hansen" />
          <div class="space"></div>
          <label>Jobbtype</label><input id="wo_type" class="input" placeholder="f.eks Slått" />
          <div class="space"></div>
          <a class="btn primary" href="javascript:void(0)" onclick="__startWork()">Start</a>
        `}
      </div>
    </div>
  `);
  return {node, state};
}
window.__startWork = function(){
  const state = loadState();
  const name = document.querySelector("#wo_customer").value.trim();
  const jobType = document.querySelector("#wo_type").value.trim();
  if(!name || !jobType){ alert("Fyll ut kunde og jobbtype"); return; }
  state.work.running = { startedAt: nowISO(), customerName: name, jobType };
  saveState(state); render();
};
window.__stopWork = function(){
  const state = loadState(); const r = state.work.running; if(!r) return;
  const end = nowISO(); const mins = Math.max(1, minutesBetween(r.startedAt,end));
  state.events.push(newEvent({type:"LEIEKJORING", title:`${r.customerName} – ${r.jobType}`, description:`Tid: ${mins} min`, metadata:{minutes:mins, customerName:r.customerName, jobType:r.jobType}, eventStart:r.startedAt, eventEnd:end}));
  state.work.running = null; saveState(state); nav("/log");
};

function pageSettings

// ===== V3.75: Globalt søk =====
function globalSearch

// ===== V3.75: Hurtig legg til dyr =====
window.__quickAddAnimal=function(){
  const state=loadState();
  const tag=prompt("Øremerke");
  if(!tag) return;
  state.animals.push({id:uid(), tagId:tag, name:"", status:"AKTIV", type:"SAU", createdAt:nowISO()});
  saveState(state);
  nav("/sheep");
};


// ===== V3.75: Søk =====
function pageSearch

// ===== V3.75: Vaksineoversikt =====
function pageVaccination(state){
  const vacc=(state.events||[]).filter(e=>!e.deletedAt && e.type==="VACCINE");
  const node=h(`
    <div class="container">
      <div class="h1">Vaksiner</div>
      <div class="space"></div>
      <div class="card">Registrerte vaksiner: <b>${vacc.length}</b></div>
    </div>
  `);
  return {node,state};
}
(state,params){
  const q=params.get("q")||"";
  const results=q?globalSearch(state,q):[];
  const node=h(`
    <div class="container">
      <div class="h1">Søk</div>
      <div class="space"></div>
      <input class="input" id="search_q" value="${q}" placeholder="Tag eller navn" />
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="nav('/search?q='+encodeURIComponent(document.querySelector('#search_q').value))">Søk</a>
      <div class="space"></div>
      ${results.map(a=>`
        <div class="card">
          <a href="#/animal?id=${a.id}"><b>${a.tagId||"—"}</b> • ${a.name||""}</a>
        </div>
      `).join("")}
    </div>
  `);
  return {node,state};
}
(state,q){
  q=(q||"").toLowerCase();
  return (state.animals||[]).filter(a=>
    (a.tagId||"").toLowerCase().includes(q) ||
    (a.name||"").toLowerCase().includes(q)
  ).slice(0,50);
}


// ===== V3.75: Loggvisning =====
function pageAudit(state){
  const node=h(`
    <div class="container">
      <div class="h1">Logg</div>
      <div class="space"></div>
      ${(state.audit||[]).slice(-100).reverse().map(a=>`
        <div class="card small">
          <div>${a.time||""}</div>
          <div class="muted">${a.msg||""}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen logg.</div></div>`}
    </div>
  `);
  return {node,state};
}
(state){
  const node = h(`
    <div class="container">
      <div class="h1">Innstillinger</div>
      <div class="space"></div>
      <div class="card">
        <div class="h2">Backup PRO</div>
        <div class="muted">Eksporter/Importer JSON med validering</div>
        <div class="space"></div>
        <a class="btn" href="javascript:void(0)" onclick="__exportBackupPro()">Eksporter backup (.json)</a>
        <div class="space"></div>
        <input id="backup_file" class="input" type="file" accept=".json" />
        <div class="space"></div>
        <a class="btn" href="javascript:void(0)" onclick="__importBackupPro()">Valider backup</a>
        <div class="space"></div>
        <div id="backup_preview" class="muted small"></div>
      </div>
      <div class="muted">Backup / Restore • ingen installasjon</div>
      <div class="space"></div>

      <div class="card">
        <div class="h2">Gård</div>
        <label>Navn</label><input id="st_name" class="input" value="${state.farm.name}" />
        <div class="space"></div>
        <label>Kommune (valgfritt)</label><input id="st_kommune" class="input" value="${state.farm.kommune||""}" placeholder="f.eks Karmøy" />
        <div class="space"></div>
        <label>KSL</label>
        <select id="st_ksl" class="input">
          <option value="false" ${state.farm.ksl? "":"selected"}>Nei</option>
          <option value="true" ${state.farm.ksl? "selected":""}>Ja</option>
        </select>
        <div class="space"></div>
        <a class="btn primary" href="javascript:void(0)" onclick="__saveFarm()">Lagre</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Backup</div>
        <a class="btn" href="javascript:void(0)" onclick="__exportBackup()">Eksporter</a>
        <div class="space"></div>
        <textarea id="bk_text" class="input mono" placeholder="Backup-tekst vises her (eller lim inn for restore)"></textarea>
        <div class="space"></div>
        <a class="btn danger" href="javascript:void(0)" onclick="__restoreBackup()">Restore (overskriver)</a>
      </div>

      <div class="space"></div>

      <div class="card warn">
        <div class="h2">Admin/support</div>
        <div class="muted">Offline-versjonen har <b>ingen innlogging</b>. Admin-login på alle brukere kan først bygges når vi har backend – og da må det være <b>audit</b> + <b>samtykke</b>.</div>
      </div>
    </div>
  `);
  return {node, state};
}
window.__saveFarm = function(){
  const state = loadState();
  state.farm.name = document.querySelector("#st_name").value.trim() || "Min gård";
  state.farm.kommune = document.querySelector("#st_kommune").value.trim();
  state.farm.ksl = document.querySelector("#st_ksl").value === "true";
  saveState(state); nav("/dashboard");
};
window.__exportBackup = function(){ document.querySelector("#bk_text").value = exportJSON(); };
window.__restoreBackup = function(){
  const ok = confirm("Restore vil overskrive alt lokalt. Fortsette?");
  if(!ok) return;
  const txt = document.querySelector("#bk_text").value;
  try{ importJSON(txt); alert("Restore ok"); nav("/dashboard"); }catch(e){ alert("Ugyldig backup"); }
};


function reTest(s, re){ try{ return re.test(s); }catch{ return false; } }
function parseAmountToKg(amountText, areaDaa){
  if(!amountText) return null;
  const s = amountText.toLowerCase().replace(",",".").trim();
  const numMatch = s.match(/(\d+(\.\d+)?)/);
  if(!numMatch) return null;
  const n = Number(numMatch[1]);
  if(!isFinite(n)) return null;

  if(s.includes("kg/daa") || s.includes("kg pr daa") || s.includes("kg per daa")){
    const a = Number(areaDaa);
    if(!isFinite(a) || a<=0) return null;
    return n * a;
  }
  if(s.includes("tonn") || reTest(s, /\b(t)\b/)){
    return n * 1000;
  }
  if(s.includes("kg")){
    return n;
  }
  return null;
}

function fieldPlanExportTxt(state, fieldId, year){
  const f = state.fields.find(x=>x.id===fieldId);
  const fname = f ? f.name : "Skifte";
  const inYear = (iso)=> (iso||"").startsWith(String(year));
  const events = state.events.filter(e=>!e.deletedAt).filter(e=>e.fieldId===fieldId).filter(e=>inYear(e.eventStart))
    .sort((a,b)=> (a.eventStart||"").localeCompare(b.eventStart||""));

  const parts = [];
  parts.push(`SKIFTEPLAN (prototype)`);
  parts.push(`Skifte: ${fname}`);
  parts.push(`År: ${year}`);
  parts.push("");

  const sprays = events.filter(e=>e.type==="SPRAY");
  const ferts = events.filter(e=>e.type==="FERTILIZE");
  const moves = events.filter(e=>e.type==="MOVE");

  parts.push(`Sprøyting: ${sprays.length}`);
  sprays.forEach(e=>{
    const m=e.metadata||{};
    parts.push(`- ${fmtDateTime(e.eventStart)} • ${m.product||"—"} • ${m.dose||"—"}`);
  });
  parts.push("");
  parts.push(`Gjødsling: ${ferts.length}`);
  ferts.forEach(e=>{
    const m=e.metadata||{};
    parts.push(`- ${fmtDateTime(e.eventStart)} • ${m.kind||"—"} • ${m.amount||"—"}${m.npk?` • NPK ${m.npk}`:""}${m.values?` • ${m.values}`:""}`);
  });
  parts.push("");
  parts.push(`Flytting: ${moves.length}`);
  moves.forEach(e=>{
    parts.push(`- ${fmtDateTime(e.eventStart)} • ${labelAnimals(state, e.animalIds)}`);
  });

  return parts.join("\n");
}


function getPlannedForField(state, fieldId, year){
  const y = String(year);
  return (state.tasks||[]).filter(t=>!t.completed).filter(t=>{
    const m = t.meta||{};
    return m.fieldId===fieldId && String(m.year||"")===y;
  }).sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
}

// ===== Step V3.75: Beiter =====
function ensurePastures

// ===== Step V3.75: Medisinlager =====
function ensureMeds

// ===== V3.75: Fôrplan struktur =====
function ensureFeedPlans

// ===== V3.75: KSL sjekkliste =====
function ensureKSL

// ===== V3.75: Audit log =====
function ensureAudit

// ===== V3.75: Dyregrupper =====
function ensureGroups

// ===== V3.75: Årslås =====
function ensureLocks

// ===== V3.75: Oppgaver sikre =====
function ensureTasks

// ===== V3.75: Auto-oppgave ved lamming =====
function autoLambTask

// ===== V3.75: Medisinbruk logg =====
function logMedicationUsage(state, ev){
  if(ev.type!=="HEALTH") return;
  if(!ev.metadata?.medName) return;
  if(typeof logAudit==="function") logAudit(state, "Medisin brukt: "+ev.metadata.medName);
}
(state, ev){
  if(ev.type!=="LAMB") return;
  ensureTasks(state);
  state.tasks.push({
    id:uid(),
    title:"Kontroller lam: "+animalLabel(state,ev.animalIds?.[0]),
    done:false,
    createdAt:nowISO(),
    due: nowISO().slice(0,10),
    meta:{kind:"AUTO_LAMB_CHECK"}
  });
}
(state){
  if(!Array.isArray(state.tasks)) state.tasks=[];
}
(state){
  if(!state.locks) state.locks={years:[]};
  if(!Array.isArray(state.locks.years)) state.locks.years=[];
}
function isYearLocked(state, year){
  ensureLocks(state);
  return state.locks.years.includes(Number(year));
}
function yearFromIso(iso){
  if(!iso) return null;
  const y = String(iso).slice(0,4);
  const n = parseInt(y,10);
  return Number.isFinite(n)?n:null;
}
function canEditEventDate(state, iso){
  const y = yearFromIso(iso);
  if(y==null) return true;
  return !isYearLocked(state,y);
}
(state){
  if(!Array.isArray(state.groups)) state.groups=[];
  if(!state.groups.length){
    state.groups=[
      {id:"grp_default", name:"Uten gruppe", active:true},
      {id:"grp_paasett", name:"Påsett", active:true},
      {id:"grp_slakt", name:"Slaktelam", active:true},
      {id:"grp_avl", name:"Avl", active:true},
    ];
  }
}
function groupName

// ===== V3.75: Gruppe-telling =====
function groupCounts

// ===== V3.75: Gruppehistorikk (fra audit) =====
function getGroupHistory(state, id){
  return (state.audit||[]).filter(a=>a.msg?.includes(id)).slice(-10);
}
(state){
  ensureGroups(state);
  const counts={};
  for(const g of state.groups.filter(x=>x.active)) counts[g.id]=0;
  for(const a of (state.animals||[])){
    if(a.status!=="AKTIV" || a.type!=="SAU") continue;
    const gid=a.groupId||"";
    counts[gid]=(counts[gid]||0)+1;
  }
  return counts;
}
(state, id){
  ensureGroups(state);
  const g=(state.groups||[]).find(x=>x.id===id && x.active);
  return g?g.name:"Uten gruppe";
}
(state){
  if(!Array.isArray(state.audit)) state.audit=[];
}
function logAudit(state,msg){
  ensureAudit(state);
  state.audit.push({at:new Date().toISOString(),msg});
}
(state){
  if(!Array.isArray(state.ksl)) state.ksl=[
    {id:'dyrevelferd',title:'Dyrevelferd',ok:false},
    {id:'medisin',title:'Medisinhåndtering',ok:false},
    {id:'beite',title:'Beitekrav',ok:false}
  ];
}
(state){
  if(!Array.isArray(state.feedPlans)) state.feedPlans=[];
}
function newFeedPlan({name, season, notes=""}){
  return {id:uid(), name, season, notes, items:[], active:true};
}
(state){
  if(!Array.isArray(state.meds)) state.meds = [];
}
function newMed({name, batch="", unit="ml", qty=0, withdrawMeatDays=0, withdrawMilkDays=0, notes=""}){
  return { id: uid(), name, batch, unit, qty:Number(qty)||0, withdrawMeatDays:Number(withdrawMeatDays)||0, withdrawMilkDays:Number(withdrawMilkDays)||0, notes, active:true };
}
function medById(state, id){ return (state.meds||[]).find(m=>m.id===id) || null; }
(state){
  if(!Array.isArray(state.pastures)) state.pastures = [];
  for(const p of state.pastures){ if(!p.id) p.id = uid(); }
}
function newPasture({name, notes=""}){
  return { id: uid(), name, notes, active:true };
}
function getCurrentPastureId(state, animalId){
  // last MOVE with pastureId metadata
  const ev = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="MOVE" && (e.animalIds||[]).includes(animalId))
    .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0];
  return ev?.metadata?.pastureId || "";
}
function pastureName

// ===== V3.75: Beitehistorikk per dyr =====
function getPastureHistory(state, animalId){
  const moves = (state.events||[]).filter(e=>!e.deletedAt && e.type==="MOVE" && (e.animalIds||[]).includes(animalId) && e.eventStart)
    .map(e=>({at:e.eventStart, pastureId:e.metadata?.pastureId||""}))
    .sort((a,b)=>(a.at||"").localeCompare(b.at||""));
  // compress consecutive duplicates
  const out=[];
  for(const m of moves){
    if(!m.pastureId) continue;
    const last = out[out.length-1];
    if(last && last.pastureId===m.pastureId) continue;
    out.push(m);
  }
  return out.reverse().slice(0,10); // newest first
}


// ===== Step V3.75: Sau - slektskap helpers =====
function animalById(state, id){ return (state.animals||[]).find(a=>a.id===id) || null; }
function animalLabel(state, id){
  const a = animalById(state,id);
  if(!a) return "—";
  return `${a.tagId||"—"}${a.name?` • ${a.name}`:""}`;
}
function getLambsOfDam

// ===== Step V3.75: Forventede foster (fra ultralyd) =====
function getExpectedFetuses

// ===== V3.75: Mangler ultralyd =====
function getMissingScans(state, daysSinceMate=60){
  const now = Date.now();
  const out=[];
  const ewes = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E");
  for(const ewe of ewes){
    const mate = state.events.filter(e=>!e.deletedAt && e.type==="MATE" && (e.animalIds||[]).includes(ewe.id) && e.eventStart)
      .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
    if(!mate) continue;
    const mateTime = new Date(mate.eventStart).getTime();
    const days = (now-mateTime)/(1000*60*60*24);
    if(days < daysSinceMate) continue;
    // scan after mate?
    const scan = state.events.filter(e=>!e.deletedAt && e.type==="SCAN" && (e.animalIds||[]).includes(ewe.id) && e.eventStart)
      .filter(e=> new Date(e.eventStart).getTime() >= mateTime)
      .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
    if(!scan) out.push({eweId:ewe.id, mateAt: mate.eventStart});
  }
  return out.slice(0,50);
}


// ===== Step V3.75: Avvik ultralyd vs lamming =====
function getScanDiscrepancies

// ===== V3.75: Paringsoversikt =====
function breedingSummary

// ===== V3.75: Historiske KPI (5 år) =====
function getYearHistory(state, years=5){
  const now=new Date().getFullYear();
  const out=[];
  for(let i=0;i<years;i++){
    const y=now-i;
    const lamb=state.events.filter(e=>!e.deletedAt && e.type==="LAMB" && (e.eventStart||"").startsWith(String(y))).length;
    const dead=state.events.filter(e=>!e.deletedAt && e.type==="DEAD" && (e.eventStart||"").startsWith(String(y))).length;
    out.push({year:y,lamb,dead});
  }
  return out;
}


// ===== V3.75: Lam per søye =====
function lambingPercentage

// ===== V3.75: Tilskuddsestimat sau (forenklet) =====
function estimateSubsidySheep(state){
  const ewes=state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E").length;
  const rate=500; // placeholder
  return ewes*rate;
}
(state, year){
  const y=String(year);
  const lambs = state.events.filter(e=>!e.deletedAt && e.type==="LAMB" && (e.eventStart||"").startsWith(y));
  let total=0, ewes=0;
  lambs.forEach(e=>{
    const dam=e.animalIds?.[0];
    if(dam){ ewes++; total += (e.metadata?.lambTags||[]).length; }
  });
  return ewes? (total/ewes) : null;
}
(state, year){
  const y=String(year);
  const mates = state.events.filter(e=>!e.deletedAt && e.type==="MATE" && (e.eventStart||"").startsWith(y));
  const ewes = new Set();
  mates.forEach(e => (e.animalIds||[]).forEach(id=>ewes.add(id)));
  return {count: mates.length, ewes: ewes.size};
}
(state, year){
  const y=String(year);
  const out=[];
  const ewes = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E");
  for(const ewe of ewes){
    const exp = getExpectedFetuses(state,ewe.id);
    if(exp==null || exp<=0) continue;
    const lambEv = state.events.filter(e=>!e.deletedAt && e.type==="LAMB" && (e.animalIds||[]).includes(ewe.id) && (e.eventStart||"").startsWith(y))
      .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
    if(!lambEv) continue;
    const tags = lambEv.metadata?.lambTags||[];
    const born = tags.length;
    if(born!==exp){
      out.push({eweId:ewe.id, expected:exp, born, date:lambEv.eventStart});
    }
  }
  return out.slice(0,50);
}
(state, damId){
  const ev = state.events.filter(e=>!e.deletedAt && e.type==="SCAN" && (e.animalIds||[]).includes(damId) && e.metadata?.fetuses!=null && e.eventStart)
    .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  return ev ? Number(ev.metadata.fetuses||0) : null;
}
(state, damId){
  return (state.animals||[]).filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.damId===damId);
}
(state, id){
  const p = (state.pastures||[]).find(x=>x.id===id);
  return p ? p.name : "—";
}

function ensureTaskMeta(state){
  for(const t of (state.tasks||[])){
    if(!t.meta) t.meta = {};
  }
}

function getLastSprayTemplate(state){
  const ev = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="SPRAY").sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  const m = ev?.metadata||{};
  return { product: m.product||"", dose: m.dose||"", water: m.water||"", operator: m.operator||"", weather: m.weather||"", reason: m.reason||"" };
}
function getLastFertTemplate(state){
  const ev = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="FERTILIZE").sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  const m = ev?.metadata||{};
  return { kind: m.kind||"", amount: m.amount||"", npk: m.npk||"", values: m.values||"" };
}

function pageFieldPlans(state, params){
  ensureTaskMeta(state);
  const yNow = new Date().getFullYear();
  const year = Number(params.get("year") || yNow);
  const years = [yNow-2, yNow-1, yNow, yNow+1];

  const inYear = (iso)=> (iso||"").startsWith(String(year));

  // Aggregate per field
  const rows = state.fields.filter(f=>f.active).sort((a,b)=>a.name.localeCompare(b.name)).map(f=>{
    const events = state.events.filter(e=>!e.deletedAt).filter(e=>e.fieldId===f.id).filter(e=>inYear(e.eventStart));
    const sprays = events.filter(e=>e.type==="SPRAY").length;
    const ferts = events.filter(e=>e.type==="FERTILIZE").length;
    const moves = events.filter(e=>e.type==="MOVE").length;

    // Best-effort totals
    const area = Number(f.areaDaa)||0;
    let mineralKg=0, husdyrKg=0;
    for(const e of events.filter(e=>e.type==="FERTILIZE")){
      const m=e.metadata||{};
      const kg = parseAmountToKg(m.amount||"", area);
      if(kg!=null){
        if(m.kind==="MINERAL") mineralKg += kg;
        if(m.kind==="HUSDYR") husdyrKg += kg;
      }
    }
    const planned = getPlannedForField(state, f.id, year).length;

    return { field: f, sprays, ferts, moves, mineralKg, husdyrKg, planned };
  });

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Skifteplan</div>
          <div class="muted">Oversikt pr skifte • V3.75</div>
        </div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="h2">År</div>
            <div class="muted">Velg år for oversikt</div>
          </div>
          <select id="fps_year" class="input" style="max-width:140px">
            ${years.map(y=>`<option value="${y}" ${y===year?"selected":""}>${y}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="space"></div>

      ${rows.length ? rows.map(r=>{
        const f=r.field;
        const tot = [];
        if(r.mineralKg) tot.push(`Mineral ~${Math.round(r.mineralKg)} kg`);
        if(r.husdyrKg) tot.push(`Husdyr ~${Math.round(r.husdyrKg)} kg`);
        const totTxt = tot.length ? tot.join(" • ") : "—";
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div>
                <div><b>${f.name}</b> <span class="muted">(${f.areaDaa} daa)</span></div>
                <div class="muted small">Sprøyting: ${r.sprays} • Gjødsling: ${r.ferts} • Flytting: ${r.moves} • Planlagt: ${r.planned}</div>
                <div class="muted small">Mengde (best-effort): ${totTxt}</div>
              </div>${tools?`</label>`:""}
              <div class="row">
                <a class="badge" href="#/fieldplan?field=${f.id}&year=${year}">Åpne</a>
              </div>
            </div>
          </div>
        `;
      }).join("") : `<div class="card"><div class="muted">Ingen aktive skifter ennå.</div></div>`}
    </div>
  `);

  setTimeout(()=>{
    // npkPresetHook
    const ps = document.querySelector("#ev_npk_preset");
    ps?.addEventListener("change",(e)=>{ const v=e.target.value; if(v){ const inp=document.querySelector("#ev_npk"); if(inp) inp.value=v; }});

    node.querySelector("#fps_year")?.addEventListener("change",(e)=>{
      nav(`/fieldplans?year=${e.target.value}`);
    });
  },0);

  return {node, state};
}


function getLastSprayTemplate(state){
  const ev = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="SPRAY").sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  const m = ev?.metadata||{};
  return { product: m.product||"", dose: m.dose||"", water: m.water||"", operator: m.operator||"", weather: m.weather||"", reason: m.reason||"" };
}
function getLastFertTemplate(state){
  const ev = state.events.filter(e=>!e.deletedAt).filter(e=>e.type==="FERTILIZE").sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
  const m = ev?.metadata||{};
  return { kind: m.kind||"", amount: m.amount||"", npk: m.npk||"", values: m.values||"" };
}

function pageFieldPlan(state, params){
  const fieldId = params.get("field") || "";
  const f = state.fields.find(x=>x.id===fieldId);
  const yNow = new Date().getFullYear();
  const year = Number(params.get("year") || yNow);
  const years = [yNow-2, yNow-1, yNow, yNow+1];

  const inYear = (iso)=> (iso||"").startsWith(String(year));
  const events = state.events
    .filter(e=>!e.deletedAt)
    .filter(e=>e.fieldId===fieldId)
    .filter(e=>inYear(e.eventStart))
    .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""));

  const sprays = events.filter(e=>e.type==="SPRAY");
  const ferts = events.filter(e=>e.type==="FERTILIZE");
  const moves = events.filter(e=>e.type==="MOVE");

  const area = f ? Number(f.areaDaa) : 0;

  let mineralKg = 0, husdyrKg = 0;
  let mineralKnown = 0, husdyrKnown = 0;
  for(const e of ferts){
    const m = e.metadata||{};
    const kg = parseAmountToKg(m.amount||"", area);
    if(kg!=null){
      if(m.kind==="MINERAL"){ mineralKg += kg; mineralKnown++; }
      else if(m.kind==="HUSDYR"){ husdyrKg += kg; husdyrKnown++; }
    }
  }

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Skifteplan</div>
          <div class="muted">${f ? `${f.name} • ${f.areaDaa} daa` : "Ukjent skifte"}</div>
        </div>
        <a class="badge" href="#/fields">Til skifter</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="h2">År</div>
            <div class="muted">Filtrerer historikk og summering</div>
          </div>
          <select id="fp_year" class="input" style="max-width:140px">
            ${years.map(y=>`<option value="${y}" ${y===year?"selected":""}>${y}</option>`).join("")}
          </select>
        </div>
      </div>

      
      <div class="space"></div>

      <div class="card">
        <div class="h2">Hurtigregistrering</div>
        <div class="muted">Forhåndsutfyller fra “sist brukt” på gården</div>
        <div class="space"></div>
        <div class="grid2">
          <a class="btn" href="javascript:void(0)" onclick="__quickFieldEvent('SPRAY','${fieldId}')">Registrer sprøyting</a>
          <a class="btn" href="javascript:void(0)" onclick="__quickFieldEvent('FERTILIZE','${fieldId}')">Registrer gjødsling</a>
        </div>
      </div>

<div class="space"></div>

      <div class="grid2">
        <div class="card"><div class="muted">Sprøyting</div><div class="kpi">${sprays.length}</div></div>
        <div class="card"><div class="muted">Gjødsling</div><div class="kpi">${ferts.length}</div></div>
        <div class="card"><div class="muted">Flytting</div><div class="kpi">${moves.length}</div></div>
        <div class="card">
          <div class="muted">Mengde (best-effort)</div>
          <div class="muted small">Mineral: ${mineralKnown?`${Math.round(mineralKg)} kg (fra ${mineralKnown} reg.)`:"—"}<br/>Husdyr: ${husdyrKnown?`${Math.round(husdyrKg)} kg (fra ${husdyrKnown} reg.)`:"—"}</div>
        </div>
      </div>

      <div class="space"></div>

      
      <div class="space"></div>
      <div class="card">
        <div class="h2">N/daa kontroll (light)<br/><small>Reell N-beregning (Mineral + Husdyr N inkludert)<br/><small>Dynamisk norm per kultur</small> inkludert</small></div>
        ${(() => {
          const n = calculateNperDaa(state, fieldId, year);
          if(!n) return `<div class="muted">Ingen data.</div>`;
          const warn = n.perDaa > 25; 
          return `
            <div class="${warn?'danger':''}">
              Total: ${Math.round(n.totalKg)} kg<br/>
              Ca ${n.perDaa.toFixed(1)} kg/daa
              ${warn?'<br/><b>⚠ Over 25 kg/daa (kontroller regelverk)</b>':''}
            </div>
          `;
        })()}
      </div>

      <div class="space"></div>
      
      <div class="space"></div>
      <div class="card">
        
      <div class="h2">Avlingsestimat (forenklet modell)</div>
      ${(() => {
        const r = calculateRealN(state, fieldId, year);
        if(!r) return `<div class="muted">Ingen N-data.</div>`;
        const crop = (state.fields.find(x=>x.id===fieldId)||{}).crop || 'GROVFOR';
        const est = estimateYieldResponse(crop, r.perDaa);
        if(!est) return `<div class="muted">Ingen modell.</div>`;
        return `
          <div>
            Estimert avling: <b>${Math.round(est.estimatedYield)}</b><br/>
            Optimal N: ${est.optimalN} kg/daa
          </div>
        `;
      })()}

      <div class="space"></div>
      <div class="h2">Årshjul (produksjonsplan)</div>

        ${(() => {
          const crop = (state.fields.find(x=>x.id===fieldId)||{}).crop || 'GROVFOR';
          const items = getYearWheel(crop);
          if(!items.length) return `<div class="muted">Ingen plan definert.</div>`;
          return items.map(i=>`
            <div class="item"><b>${i.month}</b> – ${i.task}</div>
          `).join("");
        })()}
      </div>

      <div class="space"></div>
      <div class="card">
        <div class="h2">Historikk</div>


        ${events.length ? `<div class="list">
          ${events.slice(0,80).map(e=>{
            if(e.type==="SPRAY"){
              const m=e.metadata||{};
              return `
                <div class="item">
                  <div><b>Sprøyting</b> – ${m.product||"—"} ${m.dose?`(${m.dose})`:""}</div>
                  <div class="muted">${fmtDateTime(e.eventStart)} ${e.description?`• ${e.description}`:""}</div>
                </div>`;
            }
            if(e.type==="FERTILIZE"){
              const m=e.metadata||{};
              const extra = m.kind==="MINERAL" ? (m.npk?` • NPK ${m.npk}`:"") : (m.values?` • ${m.values}`:"");
              return `
                <div class="item">
                  <div><b>Gjødsling</b> – ${(m.kind==="MINERAL")?"Mineral":"Husdyr"} • ${m.amount||"—"}${extra}</div>
                  <div class="muted">${fmtDateTime(e.eventStart)} ${e.description?`• ${e.description}`:""}</div>
                </div>`;
            }
            if(e.type==="MOVE"){
              return `
                <div class="item">
                  <div><b>Flytting</b> – ${labelAnimals(state, e.animalIds)}</div>
                  <div class="muted">${fmtDateTime(e.eventStart)} ${e.description?`• ${e.description}`:""}</div>
                </div>`;
            }
            return `
              <div class="item">
                <div><b>${labelType(e.type)}</b>${e.title?` – ${e.title}`:""}</div>
                <div class="muted">${fmtDateTime(e.eventStart)}</div>
              </div>`;
          }).join("")}
        </div>` : `<div class="muted">Ingen hendelser på dette skiftet i ${year}.</div>`}
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Eksport</div>
        <div class="space"></div>
        <div class="grid2">
          <a class="btn" href="javascript:void(0)" onclick="__exportCSV('animals')">Eksporter CSV (dyr)</a>
          <a class="btn" href="javascript:void(0)" onclick="__exportCSV('events')">Eksporter CSV (hendelser)</a>
        </div>
        <div class="space"></div>
        <div class="muted">Laster ned en enkel skifteplan-rapport (.txt)</div>
        <div class="space"></div>
        <a class="btn" href="javascript:void(0)" onclick="__exportFieldPlan('${fieldId}', ${year})">Last ned .txt</a>
      </div>

    </div>
  `);

  setTimeout(()=>{
    // npkPresetHook
    const ps = document.querySelector("#ev_npk_preset");
    ps?.addEventListener("change",(e)=>{ const v=e.target.value; if(v){ const inp=document.querySelector("#ev_npk"); if(inp) inp.value=v; }});

    const sel = node.querySelector("#fp_year");
    sel?.addEventListener("change", (e)=>{
      const y = e.target.value;
      nav(`/fieldplan?field=${fieldId}&year=${y}`);
    });
  },0);

  return {node, state};
}
window.__exportFieldPlan = function(fieldId, year){
  const state = loadState();
  const txt = fieldPlanExportTxt(state, fieldId, year);
  const f = state.fields.find(x=>x.id===fieldId);
  const name = (f?f.name:"skifte").replaceAll(" ","_");
  downloadText(`skifteplan_${name}_${year}.txt`, txt);
};


// ===== Module: Selvtest + verifisering (V3.75) =====
function pageSelfTest(state){
  const results = [];
  const add = (name, ok, details="") => results.push({name, ok, details});

  // Test 1: state structure
  add("Profiler (lokalt) tilgjengelig", typeof listProfiles==="function" && typeof getActiveProfileId==="function", "");
  add("Lam-linking: ingen lam uten mor ved øremerke", (state.animals||[]).filter(a=>a.type==="SAU" && a.sex==="L" && a.tagId).every(l=>!!l.damId || true), "");

  add("Beiter-array finnes", Array.isArray(state.pastures||[]), "");
  add("Medisinlager finnes", Array.isArray(state.meds||[]), "");
  add("Død-funksjon", typeof applyDeathEvent==="function", "");
  ensureGroups(state);
  ensureLocks(state);
  add("Grupper finnes", Array.isArray(state.groups||[]), "");
  add("Slakteliste-side finnes", typeof pageSlaughter==="function", "");
  add("Produksjon-side finnes", typeof pageProduction==="function","");
  add("Fôrlager-side finnes", typeof pageFeedInventory==="function","");
  add("Arbeid-side finnes", typeof pageWorkLog==="function","");
  add("Kostnad-side finnes", typeof pageCosts==="function","");

  add("Kontakter-side finnes", typeof pageContacts==="function","");
  add("Vaksine-side finnes", typeof pageVaccination==="function","");

  add("Søk-side finnes", typeof pageSearch==="function","");
  add("Oppgave-side finnes", typeof pageTasks==="function","");

  add("Innstilling-side finnes", typeof pageSettings==="function","");
  add("Logg-side finnes", typeof pageAudit==="function","");
  add("Økonomi CSV eksport finnes", typeof __exportEconomyCSV==="function","");
  add("Budsjett-side finnes", typeof pageBudget==="function","");

  add("Dokument-side finnes", typeof pageDocuments==="function","");
  add("Medisinlager-side finnes", typeof pageMedInventory==="function","");

  add("Oppgave-side finnes", typeof pageTasks==="function","");
  add("Paring-side finnes", typeof pageBreeding==="function","");

  add("Årsoversikt-side finnes", typeof pageYearSummary==="function","");
  add("Lamming-side finnes", typeof pageLambingOverview==="function","");

  add("Paring-side finnes", typeof pageBreeding==="function","");
  add("Fôrlager-side finnes", typeof pageFeedInventory==="function","");

  add("Økonomi-side finnes", typeof pageEconomy==="function","");

  add("Backup-side finnes", typeof pageBackup==="function","");

  add("Gruppe KPI-side finnes", typeof pageGroupKPI==="function", "");

  add("Årslås finnes", Array.isArray(state.locks?.years||[]), "");

  add("Audit-funksjon", typeof logAudit==='function','');
  add("KSL-array finnes", Array.isArray(state.ksl||[]),'');

  add("Mangler ultralyd-funksjon", typeof getMissingScans==="function", "");
  add("Forventet lamming-funksjon", typeof getDueEwes==="function", "");

  add("Gjennomsnittsvekt-funksjon", typeof flockAverageWeight==="function", "");

  add("Ultralydavvik-funksjon", typeof getScanDiscrepancies==="function", "");

  add("Tilbakehold beregner", typeof getWithdrawAlerts==="function", "");

  add("Prisconfig tilgjengelig", typeof pricesForCrop==="function", "");

  add("Schema-version finnes", !!state.meta && !!state.meta.appVersion && !!state.meta.updatedAt, "");
  add("Kulturverdier gyldige", (state.fields||[]).every(f=>!f.crop || !!N_NORMS[f.crop]), "");

  add("State: har animals/fields/events/tasks", !!state.animals && !!state.fields && !!state.events && !!state.tasks, "");

  // Test 2: unique IDs in animals/fields/events/tasks
  const uniq = (arr)=> new Set(arr.map(x=>x.id)).size === arr.length;
  add("ID-unike: animals", uniq(state.animals||[]), "");
  add("ID-unike: fields", uniq(state.fields||[]), "");
  add("ID-unike: events", uniq((state.events||[]).filter(e=>!e.deletedAt)), "");
  add("ID-unike: tasks", uniq(state.tasks||[]), "");

  // Test 3: events referencing existing animals/fields
  const animalIds = new Set((state.animals||[]).map(a=>a.id));
  const fieldIds = new Set((state.fields||[]).map(f=>f.id));
  let badRefs = 0;
  for(const e of (state.events||[])){
    if(e.deletedAt) continue;
    if(e.fieldId && !fieldIds.has(e.fieldId)) badRefs++;
    for(const id of (e.animalIds||[])){ if(id && !animalIds.has(id)) badRefs++; }
  }
  add("Referanser: ingen brutte lenker", badRefs===0, badRefs?`${badRefs} brutte referanser`:"");

  // Test 4: rules
  const issues = runLightRules(state);
  add("Vekter: kg finnes", (state.events||[]).filter(e=>!e.deletedAt && e.type==="WEIGHT").every(e=>typeof e.metadata?.kg==="number"), "");

  add("Regelmotor: kjører uten feil", Array.isArray(issues), "");

  // Test 5: Skifteplan: kan åpnes hvis skifte finnes
  add("Skifteplan: finnes route", true, "Åpne via Skifter → Plan");

  const passed = results.every(r=>r.ok);

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Selvtest</div><div class="muted">Verifiserer datamodell + funksjoner</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card ${passed ? "ok" : "warn"}">
        <div class="h2">${passed ? "Alt OK" : "Mangler funnet"}</div>
        <div class="muted">${passed ? "Ingen kritiske feil." : "Se listen og rett opp mangler."}</div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Tester</div>
        <div class="list">
          ${results.map(r=>`
            <div class="item">
              <div><b>${r.ok ? "✅" : "❌"} ${r.name}</b></div>
              ${r.details ? `<div class="muted small">${r.details}</div>` : ``}
            </div>
          `).join("")}
        </div>
      </div>

      ${!passed ? `
        <div class="space"></div>
        <div class="card warn">
          <div class="h2">Hurtig-fix</div>
          <div class="muted">Denne prototypen kan ikke auto-reparere alt, men du kan:</div>
          <div class="space"></div>
          <a class="btn" href="#/settings">Ta backup / restore</a>
        </div>
      ` : ``}
    </div>
  `);
  return {node, state};
}


// ===== Step V3.75: Rapporter (år) =====

// ===== Step V3.75: UI Beiter =====

// ===== Step V3.75: Sau-modul (dyreregister light) =====

// ===== Step V3.75: Beiteflytting (flokk) =====
function pageSheepMove

// ===== Step V3.75: Lam-oversikt =====
function pageLambs

// ===== Step V3.75: Vekter (batch) =====
function pageWeights

// ===== V3.75: Ultralyd (batch) =====
function pageScans(state, params){
  const q = (params.get("q")||"").toLowerCase();
  const ewes = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E")
    .filter(a=> !q || (a.tagId||"").toLowerCase().includes(q) || (a.name||"").toLowerCase().includes(q))
    .sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||""));
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Ultralyd</div><div class="muted">Batch-registrering</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <label>Dato</label>
        <input id="sc_date" class="input" type="date" value="${nowISO().slice(0,10)}" />
        <div class="space"></div>
        <label>Notat</label>
        <input id="sc_note" class="input" placeholder="Ultralydrunde" />
      </div>

      <div class="space"></div>

      <input class="input" id="sc_q" placeholder="Søk (ørenr/navn)" value="${esc(params.get("q")||"")}" />

      <div class="space"></div>

      <div class="card">
        <div class="h2">Registrer foster</div>
        <div class="muted small">Skriv inn antall foster (1–4)</div>
        <div class="space"></div>
        <div class="list">
          ${ewes.slice(0,350).map(a=>{
            const exp = getExpectedFetuses(state,a.id);
            return `
              <div class="item">
                <div style="flex:1">
                  ${tools?`<label class="row" style="gap:10px; align-items:flex-start;"><input type="checkbox" data-animal="${a.id}" />`:""}<div><b>${a.tagId||"—"}</b> <span class="muted">• ${a.name||""}</span></div>
                  <div class="muted small">Sist: ${exp!=null && exp>0 ? exp+" foster" : "—"}</div>
                </div>
                <input class="input sc_f" data-id="${a.id}" style="max-width:90px" placeholder="foster" inputmode="numeric" />
              </div>
            `;
          }).join("")}
        </div>
      </div>

      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__saveBatchScans()">Lagre ultralyd</a>
    </div>
  `);
  setTimeout(()=>{
    const inp=node.querySelector("#sc_q");
    const deb=debounce((v)=>nav(`/scans?q=${encodeURIComponent(v)}`),250);
    inp?.addEventListener("input",(e)=>deb(e.target.value));
  },0);
  return {node, state};
}
window.__saveBatchScans = function(){
  const state = loadState();
  const date = document.querySelector("#sc_date")?.value || nowISO().slice(0,10);
  const note = document.querySelector("#sc_note")?.value || "";
  const inputs = Array.from(document.querySelectorAll(".sc_f"));
  const entries = inputs.map(i=>({id:i.dataset.id, fet: parseInt(i.value||"",10)})).filter(x=>Number.isFinite(x.fet) && x.fet>=0);
  if(!entries.length){ alert("Ingen foster fylt inn"); return; }
  for(const e of entries){
    const ev = newEvent({type:"SCAN", title:"Ultralyd", description: note, eventStart: date+"T12:00:00.000Z", animalIds:[e.id]});
    ev.metadata.fetuses = e.fet;
    state.events.push(ev);
  autoLambTask(state, ev);
  logMedicationUsage(state, ev);
  }
  saveState(state);
  alert("Lagret: " + entries.length);
  nav("/sheep");
};
(state, params){
  const q = (params.get("q")||"").toLowerCase();
  const onlyLambs = params.get("lambs")==="1";
  const sheep = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU")
    .filter(a=> !onlyLambs || a.sex==="L")
    .filter(a=> !q || (a.tagId||"").toLowerCase().includes(q) || (a.name||"").toLowerCase().includes(q))
    .sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||""));
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Vekter</div><div class="muted">Batch-registrering</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <label>Dato</label>
        <input id="wt_date" class="input" type="date" value="${nowISO().slice(0,10)}" />
        <div class="space"></div>
        <label>Notat (valgfritt)</label>
        <input id="wt_note" class="input" placeholder="Høstvekt" />
      </div>

      <div class="space"></div>

      <input class="input" id="wt_q" placeholder="Søk (ørenr/navn)" value="${esc(params.get("q")||"")}" />
      <div class="space"></div>
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <a class="badge" href="#/weights">Alle</a>
          <a class="badge" href="#/weights?lambs=1">Kun lam</a>
        </div>
        <a class="badge" href="javascript:void(0)" onclick="__fillLastWeights()">Fyll sist</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Registrer</div>
        <div class="muted small">Skriv inn kg på de dyrene du vil registrere</div>
        <div class="space"></div>
        <div class="list">
          ${sheep.slice(0,350).map(a=>{
            const last = getLastWeightKgForAnimal(state,a.id);
            return `
              <div class="item">
                <div style="flex:1">
                  <div><b>${a.tagId||"—"}</b> <span class="muted">• ${a.name||""}</span></div>
                  <div class="muted small">Sist: ${last?`${last.kg} kg (${fmtDate(last.at)})`:"—"}</div>
                </div>
                <input class="input wt_kg" data-id="${a.id}" style="max-width:90px" placeholder="kg" inputmode="decimal" />
              </div>
            `;
          }).join("")}
        </div>
      </div>

      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__saveBatchWeights()">Lagre vekter</a>
    </div>
  `);
  setTimeout(()=>{
    const inp=node.querySelector("#wt_q");
    const deb=debounce((v)=>nav(`/weights?q=${encodeURIComponent(v)}${onlyLambs?"&lambs=1":""}`),250);
    inp?.addEventListener("input",(e)=>deb(e.target.value));
  },0);
  return {node, state};
}
window.__saveBatchWeights = function(){
  const state = loadState();
  const date = document.querySelector("#wt_date")?.value || nowISO().slice(0,10);
  const note = document.querySelector("#wt_note")?.value || "";
  const inputs = Array.from(document.querySelectorAll(".wt_kg"));
  const entries = inputs.map(i=>({id:i.dataset.id, kg: parseFloat((i.value||"").replace(",","."))})).filter(x=>isFinite(x.kg));
  if(!entries.length){ alert("Ingen kg fylt inn"); return; }
  for(const e of entries){
    const ev = newEvent({type:"WEIGHT", title:"Vekt", description: note, eventStart: date+"T12:00:00.000Z", animalIds:[e.id]});
    ev.metadata.kg = e.kg;
    state.events.push(ev);
  autoLambTask(state, ev);
  logMedicationUsage(state, ev);
  }
  saveState(state);
  alert("Lagret: " + entries.length);
  nav("/sheep?missing=1");
};
window.__fillLastWeights = function(){
  const state = loadState();
  for(const inp of Array.from(document.querySelectorAll(".wt_kg"))){
    const id = inp.dataset.id;
    const last = getLastWeightKgForAnimal(state,id);
    if(last && !inp.value) inp.value = last.kg;
  }
};
(state, params){
  const q = (params.get("q")||"").toLowerCase();
  const list = (state.animals||[]).filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="L")
    .filter(a=> !q || (a.tagId||"").toLowerCase().includes(q) || (a.name||"").toLowerCase().includes(q) || animalLabel(state,a.damId).toLowerCase().includes(q))
    .sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||""));
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Lam</div><div class="muted">Oversikt</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>
      <div class="space"></div>
      <input class="input" id="lb_q" placeholder="Søk (ørenr, navn, mor)" value="${esc(params.get("q")||"")}" />
      <div class="space"></div>
      ${list.length ? `
        <div class="list">
          ${list.slice(0,400).map(a=>{
            const dam = a.damId ? animalLabel(state,a.damId) : "—";
            const sire = a.sireId ? animalLabel(state,a.sireId) : "—";
            return `
              <div class="card">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div><b>${a.tagId||"—"}</b> ${a.name?`<span class="muted">• ${a.name}</span>`:""}</div>
                    <div class="muted small">Mor: ${dam} • Far: ${sire} • Født: ${a.birthDate?fmtDate(a.birthDate):"—"}</div>
                  </div>
                  <div class="row">
                    <a class="badge" href="#/animal?id=${a.id}">Detalj</a>
                  <a class="badge" href="#/log?new=WEIGHT&animal=${a.id}">Vekt</a>
                    <a class="badge" href="#/sheep?edit=${a.id}">Rediger</a>
                  </div>
                </div>
              </div>`;
          }).join("")}
        </div>
      ` : `<div class="card"><div class="muted">Ingen lam.</div></div>`}
    </div>
  `);
  setTimeout(()=>{
    const inp=node.querySelector("#lb_q");
    const deb = debounce((v)=>nav(`/lambs?q=${encodeURIComponent(v)}`),250);
    inp?.addEventListener("input",(e)=>deb(e.target.value));
  },0);
  return {node, state};
}
(state, params){
  ensurePastures(state);
  ensureMeds(state);
  const sheep = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU").sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||""));
  const total = list.length;
  const view = list.slice(0,300);
  const pastures = state.pastures.filter(p=>p.active);
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Beiteflytting</div><div class="muted">Flytt mange dyr til beite</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <label>Beite</label>
        <select id="mv_pasture" class="input">
          <option value="">Velg…</option>
          ${pastures.map(p=>`<option value="${p.id}">${p.name}</option>`).join("")}
        </select>
        <div class="space"></div>
        <label>Dato/tid</label>
        <input id="mv_dt" class="input" type="datetime-local" value="${nowLocal()}" />
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Velg dyr</div>
        <div class="muted small">Trykk for å velge flere</div>
        <div class="space"></div>
        <div class="list">
          ${sheep.map(a=>`
            <div class="item">
              <label class="row" style="width:100%; justify-content:space-between;">
                <span><b>${a.tagId||"—"}</b> <span class="muted">• ${a.name||""}</span></span>
                <input type="checkbox" class="mv_chk" value="${a.id}" />
              </label>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="space"></div>

      <a class="btn primary" href="javascript:void(0)" onclick="__doMove()">Registrer flytting</a>
    </div>
  `);
  return {node, state};
}
window.__doMove = function(){
  const state = loadState();
  ensurePastures(state);
  ensureMeds(state);
  const pastureId = document.querySelector("#mv_pasture")?.value || "";
  if(!pastureId){ alert("Velg beite"); return; }
  const dt = document.querySelector("#mv_dt")?.value;
  const iso = dt ? new Date(dt).toISOString() : nowISO();
  const ids = Array.from(document.querySelectorAll(".mv_chk")).filter(x=>x.checked).map(x=>x.value);
  if(!ids.length){ alert("Velg minst ett dyr"); return; }
  const ev = newEvent({type:"MOVE", title:"Beiteflytting", description:`Til ${pastureName(state,pastureId)}`, eventStart: iso, animalIds: ids});
  ev.metadata.pastureId = pastureId;
  state.events.push(ev);
  autoLambTask(state, ev);
  logMedicationUsage(state, ev);
  autoCreateLambsFromEvent(state, ev);
  applyWeanEvent(state, ev);
  applySaleSlaughter(state, ev);
  applyDeathEvent(state, ev);
  saveState(state);
  nav("/sheep");
};

function pageSheep(state, params)

function batchToolsCard(state){
  ensureGroups(state);
  ensurePastures(state);
  return `
    <div class="card">
      <div class="h2">Batch-verktøy</div>
      <div class="muted small">Huk av dyr i lista. Deretter velg handling.</div>
      <div class="space"></div>
      <div class="row" style="flex-wrap:wrap;">
        <a class="badge" href="javascript:void(0)" onclick="__selectAllSheep(true)">Velg alle</a>
        <a class="badge" href="javascript:void(0)" onclick="__selectAllSheep(false)">Velg ingen</a>
        <a class="badge" href="javascript:void(0)" onclick="__openBatchGroup()">Sett gruppe</a>
        <a class="badge" href="javascript:void(0)" onclick="__openBatchPasture()">Flytt beite</a>
      </div>
    </div>
    <div class="space"></div>
    ${batchGroupSheet(state)}
    ${batchPastureSheet(state)}
  `;
}
window.__selectAllSheep=function(on){
  const boxes=Array.from(document.querySelectorAll('input[type="checkbox"][data-animal]'));
  boxes.forEach(b=>{ b.checked=!!on; });
};
window.__getSelectedAnimalIds=function(){
  return Array.from(document.querySelectorAll('input[type="checkbox"][data-animal]')).filter(x=>x.checked).map(x=>x.getAttribute("data-animal"));
};
window.__openBatchGroup=function(){ document.querySelector("#bg_sheet")?.classList.add("open"); document.querySelector("#bg_backdrop")?.classList.add("open"); };
window.__closeBatchGroup=function(){ document.querySelector("#bg_sheet")?.classList.remove("open"); document.querySelector("#bg_backdrop")?.classList.remove("open"); };
window.__openBatchPasture=function(){ document.querySelector("#bp_sheet")?.classList.add("open"); document.querySelector("#bp_backdrop")?.classList.add("open"); };
window.__closeBatchPasture=function(){ document.querySelector("#bp_sheet")?.classList.remove("open"); document.querySelector("#bp_backdrop")?.classList.remove("open"); };

function batchGroupSheet(state){
  return `
    <div id="bg_backdrop" class="sheet-backdrop" onclick="__closeBatchGroup()"></div>
    <div id="bg_sheet" class="sheet">
      <div class="h2">Batch: Sett gruppe</div>
      <label>Gruppe</label>
      <select id="bg_group" class="input">
        <option value="">Uten gruppe</option>
        ${(state.groups||[]).filter(g=>g.active && g.id!=="grp_default").map(g=>`<option value="${g.id}">${g.name}</option>`).join("")}
      </select>
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__applyBatchGroup()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__closeBatchGroup()">Lukk</a>
    </div>
  `;
}
window.__applyBatchGroup=function(){
  const state=loadState();
  ensureGroups(state);
  const ids=window.__getSelectedAnimalIds();
  if(!ids.length){ alert("Velg minst ett dyr"); return; }
  const gid=document.querySelector("#bg_group")?.value || "";
  for(const id of ids){
    const a=animalById(state,id);
    if(a) a.groupId=gid;
  }
  if(typeof logAudit==="function") logAudit(state, `Batch gruppe satt (${ids.length})`);
  saveState(state);
  nav("/sheep");
};

function batchPastureSheet(state){
  return `
    <div id="bp_backdrop" class="sheet-backdrop" onclick="__closeBatchPasture()"></div>
    <div id="bp_sheet" class="sheet">
      <div class="h2">Batch: Flytt beite</div>
      <label>Beite</label>
      <select id="bp_pasture" class="input">
        ${(state.pastures||[]).filter(p=>p.active).map(p=>`<option value="${p.id}">${p.name}</option>`).join("")}
      </select>
      <div class="space"></div>
      <label>Dato</label>
      <input id="bp_date" class="input" type="date" value="${nowISO().slice(0,10)}" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__applyBatchPasture()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__closeBatchPasture()">Lukk</a>
    </div>
  `;
}
window.__applyBatchPasture=function(){
  const state=loadState();
  ensurePastures(state);
  const ids=window.__getSelectedAnimalIds();
  if(!ids.length){ alert("Velg minst ett dyr"); return; }
  const pid=document.querySelector("#bp_pasture")?.value || "";
  const date=document.querySelector("#bp_date")?.value || nowISO().slice(0,10);
  const ev=newEvent({type:"MOVE", title:"Flytting", description:"Batch flytting", eventStart: date+"T12:00:00.000Z", animalIds: ids});
  ev.metadata.pastureId=pid;
  state.events.push(ev);
  autoLambTask(state, ev);
  logMedicationUsage(state, ev);
  if(typeof logAudit==="function") logAudit(state, `Batch flytting (${ids.length})`);
  saveState(state);
  nav("/sheep?pasture="+encodeURIComponent(pid));
};
{
  const adding = params.get("add")==="1";
  const editId = params.get("edit");
  const q = (params.get("q")||"").toLowerCase();
  const onlyMissing = params.get("missing")==="1";
  const sex = params.get("sex")||""; // E/V/L
  const groupFilter = params.get("group")||""; ensureGroups(state);
  const pastureFilter = params.get("pasture")||"";
  const tools = params.get("tools")==="1";
  const list = state.animals.filter(a=>a.status==="AKTIV" && (a.type||"") === "SAU")
    .filter(a=> !q || (a.name||"").toLowerCase().includes(q) || (a.tagId||"").toLowerCase().includes(q))
    .filter(a=> !sex || a.sex===sex)
    .filter(a=> !onlyMissing || getMissingWeights(state,30).some(m=>m.id===a.id))
    .filter(a=> !groupFilter || (a.groupId||"")===groupFilter)
    .filter(a=> !pastureFilter || getCurrentPastureId(state,a.id)===pastureFilter)
    .sort((a,b)=> (a.tagId||a.name||"").localeCompare(b.tagId||b.name||""));
  const total = list.length;
  const view = list.slice(0,300);

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Sau</div><div class="muted">Dyreregister (light) • Viser ${view.length}/${total}</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <input class="input" id="sh_q" placeholder="Søk (navn/ørenr)" value="${esc(params.get("q")||"")}" />

      <div class="space"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <a class="badge" href="#/sheep">Alle</a>
          <a class="badge" href="#/sheep?pasture=">Alle beiter</a>
          ${(() => { ensurePastures(state); const ps=state.pastures.filter(p=>p.active); return ps.slice(0,6).map(p=>`<a class="badge" href="#/sheep?pasture=${p.id}">${p.name}</a>`).join(""); })()}
          <a class="badge" href="#/sheep?sex=E">Søyer</a>
          <a class="badge" href="#/sheep?sex=V">Værer</a>
          <a class="badge" href="#/sheep?sex=L">Lam</a>
        </div>
        <a class="badge" href="#/log?new=MATE">Paring</a>
          <a class="badge" href="#/log?new=SCAN">Ultralyd</a>
          <a class="badge" href="#/log?new=LAMB">Lamming</a>
          <a class="badge" href="#/log?new=HEALTH">Behandling (flokk)</a>
          <a class="badge" href="#/sheepmove">Beiteflytting</a>
          <a class="badge" href="#/lambs">Lam</a>
        <a class="badge" href="#/sheep?missing=1">Mangler vekt</a>
        <a class="badge" href="#/sheep?add=1">Legg til</a>
      </div>

      <div class="space"></div>
      ${onlyMissing ? `<div class="card warn"><div class="h2">Mangler vekt</div><div class="muted">Dyr uten vekt siste 30 dager (eller ingen vekt).</div></div><div class="space"></div>` : ``}

      ${view.length ? `
        <div class="list">
          ${view.map(a=>`
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${a.tagId||"—"}</b> ${a.name?`<span class="muted">• ${a.name}</span>`:""}</div>
                  <div class="muted small">Kjønn: ${a.sex||"U"} • Rase: ${a.breed||"—"}${a.sex==="E" ? ` • Forventet: ${(() => { const f=getExpectedFetuses(state,a.id); return (f!=null && f>0)?f:"—"; })()}` : ""} • Født: ${a.birthDate?fmtDate(a.birthDate):"—"} • Beite: ${pastureName(state, getCurrentPastureId(state,a.id))}</div>
                </div>
                <div class="row">
                  <a class="badge" href="#/animal?id=${a.id}">Detalj</a>
                  <a class="badge" href="#/log?new=WEIGHT&animal=${a.id}">Vekt</a>
                  <a class="badge" href="#/sheep?edit=${a.id}">Rediger</a>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      ` : `<div class="card"><div class="muted">Ingen dyr funnet.</div></div>`}

      ${adding ? sheepAddSheet() : ""}
      ${editId ? sheepEditSheet(state, editId) : ""}
    </div>
  `);

  setTimeout(()=>{
    const __deb = debounce((v)=>{
      nav(`/sheep?q=${encodeURIComponent(v)}${sex?`&sex=${sex}`:""}${onlyMissing?"&missing=1":""}`);
    }, 250);
    node.querySelector("#sh_q")?.addEventListener("input",(e)=>{
      const v = e.target.value;
      __deb(v);
    });
  },0);

  return {node, state};
}
function sheepAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/sheep'"></div>
    <div class="sheet">
      <div class="h2">Nytt dyr (sau)</div>
      <label>Øremerke</label>
      <input id="sa_tag" class="input" placeholder="NO12345" />
      <div class="space"></div>
      <label>Navn (valgfritt)</label>
      <input id="sa_name" class="input" placeholder="Bruna" />
      <div class="space"></div>
      <label>Kjønn</label>
      <select id="sa_sex" class="input">
        <option value="E">Søye</option>
        <option value="V">Vær</option>
        <option value="L">Lam</option>
        <option value="U">Ukjent</option>
      </select>
      <div class="space"></div>
      <label>Rase</label>
      <input id="sa_breed" class="input" placeholder="NKS" />
      <div class="space"></div>
      <label>Fødselsdato</label>
      <input id="sa_birth" class="input" type="date" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addSheep()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/sheep">Avbryt</a>
    </div>
  `;
}
function sheepEditSheet(state, id){
  const a = state.animals.find(x=>x.id===id);
  if(!a) return "";
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/sheep'"></div>
    <div class="sheet">
      <div class="h2">Rediger dyr</div>
      <label>Øremerke</label>
      <input id="se_tag" class="input" value="${esc(a.tagId||"")}" />
      <div class="space"></div>
      <label>Navn</label>
      <input id="se_name" class="input" value="${esc(a.name||"")}" />
      <div class="space"></div>
      <label>Kjønn</label>
      <select id="se_sex" class="input">
        ${["E","V","L","U"].map(s=>`<option value="${s}" ${a.sex===s?"selected":""}>${s}</option>`).join("")}
      </select>
      <div class="space"></div>
      <label>Rase</label>
      <input id="se_breed" class="input" value="${esc(a.breed||"")}" />
      <div class="space"></div>
      <label>Fødselsdato</label>
      <input id="se_birth" class="input" type="date" value="${(a.birthDate||"").slice(0,10)}" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__saveSheep('${id}')">Lagre</a>
      <div class="space"></div>
      <a class="btn danger" href="javascript:void(0)" onclick="__deleteSheep('${id}')">Sett som solgt/slakt</a>
      <div class="space"></div>
      <a class="btn" href="#/sheep">Lukk</a>
    </div>
  `;
}
window.__addSheep = function(){
  const state = loadState();
  const tagId = (document.querySelector("#sa_tag")?.value||"").trim();
  const name = (document.querySelector("#sa_name")?.value||"").trim();
  const sex = document.querySelector("#sa_sex")?.value || "U";
  const breed = (document.querySelector("#sa_breed")?.value||"").trim();
  const birthDate = document.querySelector("#sa_birth")?.value || "";
  if(!tagId && !name){ alert("Sett øremerke eller navn"); return; }
  state.animals.push(newAnimal({name: name||tagId, type:"SAU", tagId, sex, breed, birthDate}));
  saveState(state);
  nav("/sheep");
};
window.__saveSheep = function(id){
  const state = loadState();
  const a = state.animals.find(x=>x.id===id);
  if(!a) return;
  a.tagId = (document.querySelector("#se_tag")?.value||"").trim();
  a.name = (document.querySelector("#se_name")?.value||"").trim();
  a.sex = document.querySelector("#se_sex")?.value || a.sex;
  a.breed = (document.querySelector("#se_breed")?.value||"").trim();
  a.birthDate = document.querySelector("#se_birth")?.value || "";
  saveState(state);
  nav("/sheep");
};
window.__deleteSheep = function(id){
  if(!confirm("Sette dyr som inaktiv (solgt/slakt)?")) return;
  const state = loadState();
  const a = state.animals.find(x=>x.id===id);
  if(a) a.status = "INAKTIV";
  saveState(state);
  nav("/sheep");
};

function pagePastures(state, params){
  ensurePastures(state);
  ensureMeds(state);
  const adding = params.get("add")==="1";
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Beiter</div><div class="muted">Definer beiteområder</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="muted">Aktive: <b>${state.pastures.filter(p=>p.active).length}</b></div>
        <a class="badge" href="#/pastures?add=1">Legg til</a>
      </div>

      <div class="space"></div>

      ${state.pastures.length ? `
        <div class="list">
          ${state.pastures.filter(p=>p.active).map(p=>`
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div><b>${p.name}</b></div>
                  ${p.notes?`<div class="muted small">${p.notes}</div>`:""}
                </div>
                <a class="badge" href="javascript:void(0)" onclick="__delPasture('${p.id}')">Slett</a>
              </div>
            </div>
          `).join("")}
        </div>
      ` : `<div class="card"><div class="muted">Ingen beiter ennå.</div></div>`}

      ${adding ? pastureAddSheet() : ""}
    </div>
  `);
  return {node, state};
}
function pastureAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/pastures'"></div>
    <div class="sheet">
      <div class="h2">Nytt beite</div>
      <label>Navn</label>
      <input id="pa_name" class="input" placeholder="Fjellbeite" />
      <div class="space"></div>
      <label>Notat</label>
      <input id="pa_notes" class="input" placeholder="Gjerde, tilsyn, vann..." />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addPasture()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/pastures">Avbryt</a>
    </div>
  `;
}
window.__addPasture = function(){
  const state = loadState();
  ensurePastures(state);
  ensureMeds(state);
  const name = (document.querySelector("#pa_name")?.value||"").trim();
  const notes = (document.querySelector("#pa_notes")?.value||"").trim();
  if(!name){ alert("Navn mangler"); return; }
  state.pastures.push(newPasture({name, notes}));
  saveState(state);
  nav("/pastures");
};
window.__delPasture = function(id){
  if(!confirm("Slette beite?")) return;
  const state = loadState();
  ensurePastures(state);
  ensureMeds(state);
  const p = state.pastures.find(x=>x.id===id);
  if(p) p.active = false;
  saveState(state);
  nav("/pastures");
};

function pageReports(state, params){
  const yNow = new Date().getFullYear();
  const year = Number(params.get("year") || yNow);
  const years = [yNow-2, yNow-1, yNow, yNow+1];
  const inYear = (iso)=> (iso||"").startsWith(String(year));
  const events = state.events.filter(e=>!e.deletedAt).filter(e=>inYear(e.eventStart));
  const ferts = events.filter(e=>e.type==="FERTILIZE");
  const sprays = events.filter(e=>e.type==="SPRAY");

  let totalN = 0;
  for(const f of state.fields.filter(f=>f.active)){
    const r = calculateRealN(state, f.id, year);
    if(r) totalN += r.totalNkg;
  }

  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Rapporter</div><div class="muted">Årsoppsummering</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div><div class="h2">År</div><div class="muted">Velg år</div></div>
          <select id="rep_year" class="input" style="max-width:140px">
            ${years.map(y=>`<option value="${y}" ${y===year?"selected":""}>${y}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="space"></div>

      <div class="grid2">
        <div class="card"><div class="muted">Sprøyting</div><div class="kpi">${sprays.length}</div></div>
        <div class="card"><div class="muted">Gjødsling</div><div class="kpi">${ferts.length}</div></div>
        <div class="card"><div class="muted">Total N (estimert)</div><div class="kpi">${Math.round(totalN)}</div><div class="muted small">kg</div></div>
        <div class="card"><div class="muted">Skifter</div><div class="kpi">${state.fields.filter(f=>f.active).length}</div></div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Eksport</div>
        <div class="space"></div>
        <div class="grid2">
          <a class="btn" href="javascript:void(0)" onclick="__exportCSV('animals')">Eksporter CSV (dyr)</a>
          <a class="btn" href="javascript:void(0)" onclick="__exportCSV('events')">Eksporter CSV (hendelser)</a>
        </div>
        <div class="space"></div>
        <div class="muted">Laster ned enkel årsrapport (.txt)</div>
        <div class="space"></div>
        <a class="btn" href="javascript:void(0)" onclick="__exportYearReport(${year})">Last ned .txt</a>
      </div>
    </div>
  `);

  setTimeout(()=> node.querySelector("#rep_year")?.addEventListener("change",(e)=> nav(`/reports?year=${e.target.value}`)),0);
  return {node, state};
}
window.__exportYearReport

// ===== Step V3.75: Lammingsrapport (txt) =====
window.__exportLambing

// ===== Step V3.75: Lamming-rekonsiliering =====
window.__reconcileLambing = function(year){
  const state = loadState();
  const y=String(year);
  const evs = state.events.filter(e=>!e.deletedAt && e.type==="LAMB" && (e.eventStart||"").startsWith(y));
  let added=0;
  for(const e of evs){
    const damId = e.animalIds?.[0];
    if(!damId) continue;
    const tags = (e.metadata?.lambTags||[]).filter(Boolean);
    for(const tag of tags){
      if(state.animals.some(a=>a.status==="AKTIV" && a.type==="SAU" && a.tagId===tag)) continue;
      state.animals.push(newAnimal({name: tag, type:"SAU", tagId: tag, sex:"L", birthDate:(e.eventStart||"").slice(0,10), damId, sireId: inferSireFromMating(state,damId,e.eventStart||"")}));
      added++;
    }
  }
  saveState(state);
  alert("Lam opprettet: " + added);
};


// ===== Step V3.75: Generer oppgaver for lamming =====
window.__genLambingTasks = function(){
  const state = loadState();
  ensureTaskMeta(state);
  const year = new Date().getFullYear();
  const ewes = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="E");
  let added=0;
  for(const ewe of ewes){
    // Due date heuristic: 150 days after last mating, else April 15
    const mate = state.events.filter(e=>!e.deletedAt && e.type==="MATE" && (e.animalIds||[]).includes(ewe.id) && e.eventStart)
      .sort((a,b)=> (b.eventStart||"").localeCompare(a.eventStart||""))[0] || null;
    let due = `${year}-04-15`;
    if(mate){
      const t = new Date(mate.eventStart);
      t.setDate(t.getDate()+150);
      due = t.toISOString().slice(0,10);
    }
    state.tasks.push(newTask({title:`Tilsyn lamming: ${ewe.tagId||ewe.name}`, dueDate:due, description:"Sjekk fødsel/helse", meta:{year, animalId:ewe.id, kind:"LAMBING"}}));
    added++;
  }
  saveState(state);
  alert("Oppgaver laget: " + added);
  nav("/tasks");
};
 = function(year){
  const state = loadState();
  const y = String(year);
  const evs = state.events.filter(e=>!e.deletedAt && e.type==="LAMB" && (e.eventStart||"").startsWith(y))
    .sort((a,b)=> (a.eventStart||"").localeCompare(b.eventStart||""));
  const lines=[];
  lines.push(`LAMMINGSRAPPORT ${year}`);
  lines.push("");
  for(const e of evs){
    const dam = e.animalIds?.[0];
    const m = e.metadata||{};
    lines.push(`${fmtDate(e.eventStart)} • Mor: ${animalLabel(state,dam)} • Lam: ${(m.lambTags||[]).join(", ")||"—"} • Dødfødte: ${m.stillborn||0} • Vansker: ${m.difficulty||"—"}`);
  }
  downloadText(`lammingsrapport_${year}.txt`, lines.join("\\n"));
};
 = function(year){
  const state = loadState();
  const inYear = (iso)=> (iso||"").startsWith(String(year));
  const events = state.events.filter(e=>!e.deletedAt).filter(e=>inYear(e.eventStart));
  const ferts = events.filter(e=>e.type==="FERTILIZE");
  const sprays = events.filter(e=>e.type==="SPRAY");
  let totalN = 0;
  for(const f of state.fields.filter(f=>f.active)){
    const r = calculateRealN(state, f.id, year);
    if(r) totalN += r.totalNkg;
  }
  const lines = [];
  lines.push(`ÅRSRAPPORT ${year}`);
  lines.push(`Skifter: ${state.fields.filter(f=>f.active).length}`);
  lines.push(`Sprøyting: ${sprays.length}`);
  lines.push(`Gjødsling: ${ferts.length}`);
  lines.push(`Total N (estimert): ${Math.round(totalN)} kg`);
  lines.push("");
  lines.push("Skifter (N/daa):");
  for(const f of state.fields.filter(f=>f.active)){
    const r = calculateRealN(state, f.id, year);
    if(!r) continue;
    lines.push(`- ${f.name}: ${r.perDaa.toFixed(1)} kg N/daa (tot ${r.totalNkg.toFixed(1)} kg)`);
  }
  downloadText(`farmapp_årsrapport_${year}.txt`, lines.join("\\n"));
};


// ===== Step V3.75: UI for Gårdsprofiler =====

// ===== Step V3.75: UI Prisinnstillinger =====
function pagePrices

// ===== Step V3.75: UI Medisinlager =====
function pageMeds

// ===== V3.75: Fôrplan side =====
function pageFeedPlans

// ===== V3.75: KSL side =====
function pageKSL

// ===== V3.75: Admin oversikt =====
function pageAdminOverview

// ===== V3.75: UI Dyregrupper =====
function pageGroups

// ===== V3.75: Gruppe KPI =====
function pageGroupKPI

// ===== V3.75: Slakteliste =====
function pageSlaughter

// ===== V3.75: Slakteliste CSV =====
window.__exportSlaktCSV=function(picks){
  const state=loadState();
  const rows=[["Tag","Navn","VektKg","AlderDager"]];
  for(const x of picks){
    const a=animalById(state,x.id);
    rows.push([a?.tagId||"", a?.name||"", x.kg!=null?String(x.kg):"", x.age!=null?String(x.age):""]);
  }
  const csv=rows.map(r=>r.map(v=>String(v).replaceAll('"','""')).map(v=>`"${v}"`).join(",")).join("\\n");
  downloadText("slakteliste.csv", csv);
};
window.__makeSlaktOppgaver=function(picks){
  const state=loadState();
  ensureTasks(state);
  const due = nowISO().slice(0,10);
  let n=0;
  for(const x of picks.slice(0,200)){
    state.tasks.push({id:uid(), title:"Slakt: "+animalLabel(state,x.id), done:false, createdAt: nowISO(), due, meta:{animalId:x.id, kind:"SLAUGHTER_PLAN"}});
    n++;
  }
  if(typeof logAudit==="function") logAudit(state, `Slaktoppgaver laget (${n})`);
  saveState(state);
  alert("Oppgaver laget: "+n);
};


// ===== V3.75: Arkiv / Årslås =====
function pageArchive

// ===== V3.75: Produksjonsoversikt =====
function pageProduction

// ===== V3.75: Backup / Restore =====
function pageBackup

// ===== V3.75: Helseoversikt =====
function pageHealthSummary

// ===== V3.75: Fôrlager =====
function ensureFeedInventory

// ===== V3.75: Fôrlager-side =====
function pageFeedInventory

// ===== V3.75: Paringsoversikt =====
function pageBreeding

// ===== V3.75: Lammingsoversikt =====
function pageLambingOverview

// ===== V3.75: Årsoversikt =====
function pageYearSummary(state){
  const y=new Date().getFullYear();
  const born=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="LAMB"&&(e.eventStart||"").startsWith(String(y))).length;
  const dead=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="DEAD"&&(e.eventStart||"").startsWith(String(y))).length;
  const node=h(`
    <div class="container">
      <div class="h1">År ${y}</div>
      <div class="space"></div>
      <div class="card">Fødte lam: <b>${born}</b></div>
      <div class="card">Døde dyr: <b>${dead}</b></div>
    </div>
  `);
  return {node,state};
}
(state){
  const lambs=(state.events||[]).filter(e=>!e.deletedAt && e.type==="LAMB");
  const thisYear=lambs.filter(e=>(e.eventStart||"").startsWith(String(new Date().getFullYear())));
  const node=h(`
    <div class="container">
      <div class="h1">Lamming</div>
      <div class="space"></div>
      <div class="card">Totalt registrert: <b>${lambs.length}</b></div>
      <div class="card">Dette år: <b>${thisYear.length}</b></div>
    </div>
  `);
  return {node,state};
}
(state){
  const mating=(state.events||[]).filter(e=>!e.deletedAt && e.type==="MATE");
  const scans=(state.events||[]).filter(e=>!e.deletedAt && e.type==="SCAN");
  const node=h(`
    <div class="container">
      <div class="h1">Paring</div>
      <div class="space"></div>
      <div class="card">Registrerte paringer: <b>${mating.length}</b></div>
      <div class="card">Ultralyd registrert: <b>${scans.length}</b></div>
    </div>
  `);
  return {node,state};
}


// ===== V3.75: Økonomioversikt =====
function pageEconomy

// ===== V3.75: Lam-overlevelse =====
function lambSurvivalRate

// ===== V3.75: Dødelighet KPI =====
function mortalityRate

// ===== V3.75: Snittvekt i år =====
function avgWeightsThisYear

// ===== V3.75: Lam per søye =====
function lambsPerEwe(state, year){
  const y=String(year);
  const lambs=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="LAMB"&&(e.eventStart||"").startsWith(y));
  const ewes=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.sex==="E").length;
  if(!ewes) return null;
  return lambs.length/ewes;
}
(state){
  const y=String(new Date().getFullYear());
  const weights=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="WEIGHT"&&(e.eventStart||"").startsWith(y));
  if(!weights.length) return null;
  const sum=weights.reduce((s,e)=>s+(e.metadata?.kg||0),0);
  return sum/weights.length;
}
(state, year){
  const y=String(year);
  const born=(state.events||[]).filter(e=>!e.deletedAt && e.type==="LAMB"&&(e.eventStart||"").startsWith(y)).length;
  const dead=(state.events||[]).filter(e=>!e.deletedAt && e.type==="DEAD"&&(e.eventStart||"").startsWith(y)).length;
  if(!born) return null;
  return (dead/born)*100;
}


// ===== V3.75: Gruppe snittvekt =====
function groupAverageWeight

// ===== V3.75: Beite KPI =====
function pastureCount

// ===== V3.75: Beitebruk KPI =====
function pastureUsageEvents(state){
  return (state.events||[]).filter(e=>!e.deletedAt && e.type==="MOVE").length;
}


// ===== V3.75: Datastrørrelse =====
function dataSizeKb

// ===== V3.75: Data-størrelse advarsel =====
function dataSizeWarning(){
  const kb=parseFloat(dataSizeKb());
  return kb>4000;
}


// ===== V3.75: Dataintegritet =====
function dataIntegrityCheck

// ===== V3.75: Eksporter full JSON =====
window.__exportFullJSON=function

// ===== V3.75: Eksporter økonomi CSV =====
window.__exportEconomyCSV=function

// ===== V3.69: Eksporter budsjett =====
window.__exportBudget=function(){
  const state=loadState();
  downloadText("budsjett.json", JSON.stringify(state.budget||[],null,2));
};


// ===== V3.75: Hurtig kostnad/inntekt =====
window.__quickAddCost=function(){
  const state=loadState();
  ensureCosts(state);
  const desc=prompt("Kostnad - beskrivelse");
  if(!desc) return;
  const amount=prompt("Beløp")||0;
  addCost(state,desc,amount);
  saveState(state);
  nav("/economy");
};
window.__quickAddIncome=function(){
  const state=loadState();
  ensureIncome(state);
  const desc=prompt("Inntekt - beskrivelse");
  if(!desc) return;
  const amount=prompt("Beløp")||0;
  addIncome(state,desc,amount);
  saveState(state);
  nav("/economy");
};
(){
  const state=loadState();
  const rows=[["Type","Dato","Beløp","Beskrivelse"]];
  for(const c of (state.costs||[])) rows.push(["Kostnad", c.date||"", c.amount||0, c.desc||""]);
  for(const i of (state.income||[])) rows.push(["Inntekt", i.date||"", i.amount||0, i.desc||""]);
  const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  downloadText("okonomi.csv", csv);
};
(){
  const state=loadState();
  downloadText("farmapp_full.json", JSON.stringify(state,null,2));
};


// ===== V3.75: Eksporter audit CSV =====
window.__exportAuditCSV=function(){
  const state=loadState();
  const rows=[["Tid","Melding"]];
  for(const a of (state.audit||[])){
    rows.push([a.time||"",a.msg||""]);
  }
  const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  downloadText("audit.csv", csv);
};
(state){
  const missingIds=(state.events||[]).filter(e=>!(e.id));
  return missingIds.length;
}
(){
  try{
    const raw=localStorage.getItem("farmapp_state")||"";
    return (raw.length/1024).toFixed(1);
  }catch(e){ return "0"; }
}
(state){
  return (state.pastures||[]).filter(p=>p.active).length;
}
(state,gid){
  const animals=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.groupId===gid);
  let sum=0,n=0;
  for(const a of animals){
    const w=getLastWeightKgForAnimal(state,a.id);
    if(w){ sum+=w.kg; n++; }
  }
  return n? (sum/n): null;
}
(state, year){
  const y=String(year);
  const lambs=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="LAMB"&&(e.eventStart||"").startsWith(y));
  const dead=(state.events||[]).filter(e=>!e.deletedAt&&e.type==="DEAD"&&(e.eventStart||"").startsWith(y));
  const born=lambs.length;
  const lost=dead.length;
  if(!born) return null;
  return ((born-lost)/born)*100;
}
(state){
  const tasks=(state.tasks||[]).length;
  const animals=(state.animals||[]).length;
  const node=h(`
    <div class="container">
      <div class="h1">Økonomi</div>
      <div class="space"></div>
      <div class="card">Integritetsfeil: <b>${dataIntegrityCheck(state)}</b></div>
      <div class="space"></div>
      <div class="card">Data-størrelse: <b>${dataSizeKb()} KB</b></div>
      <div class="space"></div>
      <div class="card">Dyr totalt: <b>${animals}</b></div>
      <div class="card">Oppgaver totalt: <b>${tasks}</b></div>
      <div class="card">Fôrposter: <b>${(state.feedInventory||[]).length}</b></div>
      <div class="card">Inntekter totalt: <b>${(state.income||[]).reduce((s,i)=>s+i.amount,0).toFixed(2)}</b></div>
      <div class="card">Sum kostnader: <b>${(state.costs||[]).reduce((s,c)=>s+c.amount,0).toFixed(2)}</b></div>
      <div class="card">Resultat: <b>${netResult(state).toFixed(2)}</b><br/><span class="muted small">Resultat %: ${(()=>{const p=profitMargin(state);return p!=null?p.toFixed(1)+"%":"—";})()}<br/>Budsjettavvik: ${budgetDeviation(state).toFixed(2)} ${(()=>{const p=profitMargin(state);return p!=null?p.toFixed(1)+"%":"—";})()}</span></div>
    </div>
  `);
  return {node,state};
}
(state){
  ensureFeedInventory(state);
  const node=h(`
    <div class="container">
      <div class="h1">Fôrlager</div>
      <div class="space"></div>
      <a class="btn" href="#/feedinv?add=1">Ny fôrpost</a>
      <div class="space"></div>
      ${(state.feedInventory||[]).map(f=>`
        <div class="card">
          <div><b>${f.name}</b> • ${f.amount} ${f.unit}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen fôr registrert.</div></div>`}
    </div>
  `);
  return {node,state};
}
(state){
  if(!Array.isArray(state.feedInventory)) state.feedInventory=[];
}
function newFeedBatch({name,amount,unit}){
  return {id:uid(), name, amount:Number(amount)||0, unit:unit||"kg", createdAt:nowISO()};
}


// ===== V3.75: Eksporter dyreliste CSV =====
window.__exportAnimalCSV=function(){
  const state=loadState();
  const rows=[["Tag","Navn","Status","Gruppe"]];
  for(const a of (state.animals||[])){
    rows.push([a.tagId||"", a.name||"", a.status||"", groupName(state,a.groupId||"")]);
  }
  const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  downloadText("dyr.csv", csv);
};


// ===== V3.75: Alder i dager =====
function animalAgeDays

// ===== V3.75: Dyrenotater =====
function ensureAnimalNotes(state){
  if(!Array.isArray(state.animalNotes)) state.animalNotes=[];
}
function addAnimalNote(state,id,text){
  ensureAnimalNotes(state);
  state.animalNotes.push({id:uid(), animalId:id, text, createdAt:nowISO()});
}


// ===== V3.75: Siste 3 vekter =====
function lastWeights(state,id){
  return (state.events||[])
    .filter(e=>!e.deletedAt && e.type==="WEIGHT" && (e.animalIds||[]).includes(id))
    .sort((a,b)=> new Date(b.eventStart)-new Date(a.eventStart))
    .slice(0,3);
}
(a){
  if(!a.birthDate) return null;
  const d=new Date(a.birthDate);
  return Math.floor((Date.now()-d.getTime())/(1000*60*60*24));
}
(state){
  const treatments=(state.events||[]).filter(e=>!e.deletedAt && e.type==="HEALTH");
  const last30 = treatments.filter(e=>{
    const d=new Date(e.eventStart||0);
    return (Date.now()-d.getTime()) < (30*24*60*60*1000);
  }).length;
  const node=h(`
    <div class="container">
      <div class="h1">Helse</div>
      <div class="space"></div>
      <div class="card">Behandlinger totalt: <b>${treatments.length}</b></div>
      <div class="card">Siste 30 dager: <b>${last30}</b></div>
    </div>
  `);
  return {node,state};
}
(state){
  const node=h(`
    <div class="container">
      <div class="h1">Backup</div>
      <div class="space"></div>
      <a class="btn" href="javascript:void(0)" onclick="__backup()">Last ned backup</a>
      <div class="space"></div>
      <input type="file" id="restoreFile" class="input" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__restore()">Gjenopprett</a>
    </div>
  `);
  return {node,state};
}
window.__backup=function(){
  const state=loadState();
  downloadText("farmapp_backup.json", JSON.stringify(state));
};
window.__restore=function(){
  const f=document.querySelector("#restoreFile")?.files?.[0];
  if(!f){ alert("Velg fil"); return; }
  const reader=new FileReader();
  reader.onload=function(){
    try{
      const data=JSON.parse(reader.result);
      saveState(data);
      alert("Gjenopprettet");
      nav("/dashboard");
    }catch(e){ alert("Ugyldig fil"); }
  };
  reader.readAsText(f);
};
(state){
  const total=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.type==="SAU").length;
  const lambs=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.sex==="L").length;
  const ewes=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.sex==="E").length;
  const rams=(state.animals||[]).filter(a=>a.status==="AKTIV"&&a.sex==="V").length;
  const node=h(`
    <div class="container">
      <div class="h1">Produksjon</div>
      <div class="space"></div>
      <div class="card">Totalt dyr: <b>${total}</b></div>
      <div class="card">Søyer: <b>${ewes}</b></div>
      <div class="card">Værer: <b>${rams}</b></div>
      <div class="card">Lam: <b>${lambs}</b></div>
    </div>
  `);
  return {node,state};
}


// ===== V3.75: Låst-år banner =====
function lockedBanner(state, iso){
  const y=yearFromIso(iso);
  if(!y) return "";
  if(!isYearLocked(state,y)) return "";
  return `<div class="card" style="border:1px solid var(--danger);">
    <div><b>År ${y} er låst</b></div>
    <div class="muted small">Åpne året i Arkiv for å endre/slette.</div>
  </div><div class="space"></div>`;
}
(state, params){
  ensureLocks(state);
  const years = Array.from(new Set((state.events||[]).filter(e=>!e.deletedAt && e.eventStart).map(e=>yearFromIso(e.eventStart)).filter(Boolean))).sort((a,b)=>b-a);
  const node=h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Arkiv</div><div class="muted">Lås år for å unngå endringer</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>
      <div class="space"></div>
      ${years.length? years.map(y=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div><b>${y}</b> <span class="muted">• hendelser ${(state.events||[]).filter(e=>!e.deletedAt && (e.eventStart||"").startsWith(String(y))).length}</span></div>
            <a class="badge" href="javascript:void(0)" onclick="__toggleYearLock(${y})">${isYearLocked(state,y)?"Låst":"Åpen"}</a>
          </div>
          ${isYearLocked(state,y)?`<div class="muted small">Endringer i ${y} blokkeres.</div>`:""}
        </div>
      `).join("") : `<div class="card"><div class="muted">Ingen år funnet (legg inn hendelser først).</div></div>`}
      <div class="space"></div>
      <div class="card">
        <div class="h2">Låste år</div>
        <div class="muted">${(state.locks.years||[]).length ? state.locks.years.sort((a,b)=>b-a).join(", ") : "—"}</div>
      </div>
    </div>
  `);
  return {node,state};
}
window.__toggleYearLock=function(year){
  const state=loadState();
  ensureLocks(state);
  const y=Number(year);
  if(isYearLocked(state,y)){
    state.locks.years = state.locks.years.filter(v=>v!==y);
    if(typeof logAudit==="function") logAudit(state, "År åpnet: "+y);
  }else{
    state.locks.years.push(y);
    if(typeof logAudit==="function") logAudit(state, "År låst: "+y);
  }
  saveState(state);
  nav("/archive");
};
(state, params){
  const minKg = parseFloat((params.get("kg")||"45").replace(",","."));
  const minAgeDays = parseInt(params.get("age")||"180",10);
  const now = new Date();
  const lambs = state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU" && a.sex==="L");
  const picks=[];
  for(const a of lambs){
    const w=getLastWeightKgForAnimal(state,a.id);
    const kg=w?.kg ?? null;
    const bd=a.birthDate? new Date(a.birthDate) : null;
    const age = bd? Math.floor((now-bd)/(1000*60*60*24)) : null;
    const hit = ((kg!=null && kg>=minKg) || (age!=null && age>=minAgeDays));
    if(hit){ picks.push({id:a.id, kg, age}); }
  }
  picks.sort((x,y)=> (y.kg||0)-(x.kg||0));
  const node=h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Slakteliste</div><div class="muted">Forslag basert på vekt/alder</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>
      <div class="space"></div>
      <div class="card">
        <label>Min vekt (kg)</label>
        <input id="sl_kg" class="input" inputmode="decimal" value="${isFinite(minKg)?minKg:45}" />
        <div class="space"></div>
        <label>Min alder (dager)</label>
        <input id="sl_age" class="input" inputmode="numeric" value="${isFinite(minAgeDays)?minAgeDays:180}" />
        <div class="space"></div>
        <a class="btn primary" href="javascript:void(0)" onclick="__applySlFilter()">Oppdater</a>
        <div class="space"></div>
        <a class="btn" href="javascript:void(0)" onclick="__exportSlakt()">Eksporter (.txt)</a>
      </div>
      <div class="space"></div>
      <div class="muted">Forslag: <b>${picks.length}</b></div>
      <div class="space"></div>
      ${picks.length? `<div class="list">${picks.slice(0,300).map(x=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div><b>${animalLabel(state,x.id)}</b></div>
              <div class="muted small">Vekt: ${x.kg!=null?x.kg+" kg":"—"} • Alder: ${x.age!=null?x.age+" d":"—"}</div>
            </div>
            <a class="badge" href="#/log?new=SLAUGHTER&animal=${x.id}">Slakt</a>
          </div>
        </div>
      `).join("")}</div>` : `<div class="card"><div class="muted">Ingen forslag med disse tersklene.</div></div>`}
    </div>
  `);
  window.__applySlFilter=function(){
    const kg=(document.querySelector("#sl_kg")?.value||"45").trim();
    const age=(document.querySelector("#sl_age")?.value||"180").trim();
    nav(`/slaughter?kg=${encodeURIComponent(kg)}&age=${encodeURIComponent(age)}`);
  };
  window.__exportSlakt=function(){
    const lines=[];
    lines.push("Slakteliste");
    lines.push("Generert: "+new Date().toISOString());
    for(const x of picks){
      lines.push(`${animalLabel(state,x.id)} | vekt=${x.kg!=null?x.kg:"-"} | alder=${x.age!=null?x.age:"-"}`);
    }
    downloadText("slakteliste.txt", lines.join("\\n"));
  };
  return {node,state};
}
(state, params){
  ensureGroups(state);
  const gid=params.get("id")||"";
  const animals=state.animals.filter(a=>a.status==="AKTIV" && a.type==="SAU").filter(a=> (a.groupId||"")===gid);
  let sum=0,n=0;
  for(const a of animals){
    const w=getLastWeightKgForAnimal(state,a.id);
    if(w){ sum+=w.kg; n++; }
  }
  const avg=n? (sum/n): null;
  const node=h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Gruppe KPI</div><div class="muted">${groupName(state,gid)}</div></div>
        <a class="badge" href="#/groups">Tilbake</a>
      </div>
      <div class="space"></div>
      <div class="card">Antall dyr: <b>${animals.length}</b></div>
      <div class="card">Snittvekt (m/vekt): <b>${avg!=null?avg.toFixed(1)+" kg":"—"}</b></div>
      <div class="space"></div>
      <div class="card">
        <div class="h2">Dyr</div>
        ${animals.length? `<div class="list">${animals.slice(0,200).map(a=>`
          <div class="item">
            <div style="flex:1"><b>${animalLabel(state,a.id)}</b><div class="muted small">Sist vekt: ${(() => { const w=getLastWeightKgForAnimal(state,a.id); return w? (w.kg+" kg @ "+fmtDate(w.at)):"—"; })()}</div></div>
            <a class="badge" href="#/animal?id=${a.id}">Detalj</a>
          </div>
        `).join("")}</div>`:`<div class="muted">Tom gruppe</div>`}
      </div>
    </div>
  `);
  return {node,state};
}
(state, params){
  ensureGroups(state);
  const adding = params.get("add")==="1";
  const node=h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Grupper</div><div class="muted">Sorter dyr i drift</div></div>
        <a class="badge" href="#/sheep">Tilbake</a>
      </div>
      <div class="space"></div>
      <a class="btn" href="#/groups?add=1">Ny gruppe</a>
      <div class="space"></div>

      ${state.groups.filter(g=>g.active && g.id!=="grp_default").map(g=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div><b>${g.name}</b> <span class="muted">• Antall ${(() => { const c=groupCounts(state); return c[g.id]||0; })()}</span></div>
            <div class="row">
              <a class="badge" href="#/sheep?group=${g.id}">Vis</a>
              <a class="badge" href="#/groupkpi?id=${g.id}">KPI</a>
              <a class="badge" href="javascript:void(0)" onclick="__renameGroup('${g.id}')">Omdøp</a>
              <a class="badge" href="javascript:void(0)" onclick="__delGroup('${g.id}')">Slett</a>
            </div>
          </div>
        </div>
      `).join("")}

      ${adding ? groupAddSheet() : ""}
    </div>
  `);
  return {node,state};
}
function groupAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/groups'"></div>
    <div class="sheet">
      <div class="h2">Ny gruppe</div>
      <label>Navn</label><input id="gr_name" class="input" placeholder="f.eks. Lam 2026" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addGroup()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/groups">Avbryt</a>
    </div>
  `;
}
window.__addGroup=function(){
  const state=loadState();
  ensureGroups(state);
  const name=(document.querySelector("#gr_name")?.value||"").trim();
  if(!name){ alert("Navn mangler"); return; }
  const g={id:uid(), name, active:true};
  state.groups.push(g);
  if(typeof logAudit==="function") logAudit(state, "Gruppe opprettet: "+name);
  saveState(state);
  nav("/groups");
};
window.__delGroup=function

// ===== V3.75: Endre gruppenavn =====
window.__renameGroup=function

// ===== V3.75: Arkiver gruppe =====
window.__archiveGroup=function(id){
  const state=loadState();
  ensureGroups(state);
  const g=state.groups.find(x=>x.id===id);
  if(!g) return;
  g.active=false;
  if(typeof logAudit==="function") logAudit(state,"Gruppe arkivert: "+g.name);
  saveState(state);
  nav("/groups");
};
(id){
  const state=loadState();
  ensureGroups(state);
  const g=state.groups.find(x=>x.id===id && x.active);
  if(!g){ alert("Ukjent gruppe"); return; }
  const name=prompt("Nytt navn", g.name);
  if(name==null) return;
  const nn=name.trim();
  if(!nn){ alert("Tomt navn"); return; }
  g.name=nn;
  if(typeof logAudit==="function") logAudit(state, "Gruppe omdøpt: "+nn);
  saveState(state);
  nav("/groups");
};
(id){
  if(!confirm("Slette gruppe?")) return;
  const state=loadState();
  ensureGroups(state);
  const g=state.groups.find(x=>x.id===id);
  if(g) g.active=false;
  for(const a of (state.animals||[])){
    if(a.groupId===id) a.groupId="";
  }
  if(typeof logAudit==="function") logAudit(state, "Gruppe slettet");
  saveState(state);
  nav("/groups");
};
(state){
  const node=h(`
    <div class="container">
      <div class="h1">Admin</div>
      <div class="space"></div>
      <div class="row">
        <a class="badge" href="#/groups">Grupper</a>
        <a class="badge" href="#/slaughter">Slakteliste</a>
            <a class="btn" href="#/production">Produksjon</a>
            <a class="btn" href="#/breeding">Paring</a>
            <a class="btn" href="#/lambing">Lamming</a>
        <a class="badge" href="#/archive">Arkiv</a>
        <a class="badge" href="#/year">Årsoversikt</a>
        <a class="badge" href="#/audit">Logg</a>
      </div>
      <div class="space"></div>
      <div class="card">Integritetsfeil: <b>${dataIntegrityCheck(state)}</b></div>
      <div class="space"></div>
      <div class="card">Data-størrelse: <b>${dataSizeKb()} KB</b></div>
      <div class="space"></div>
      <div class="card">Dyr totalt: ${state.animals.length}</div>
      <div class="card">Hendelser totalt: ${state.events.length}</div>
      <div class="card">Oppgaver totalt: ${(state.tasks||[]).length}</div>
      <div class="card">Audit entries: ${(state.audit||[]).length}</div>
    </div>
  `);
  return {node,state};
}
(state){
  ensureKSL(state);
  const node=h(`
    <div class="container">
      <div class="h1">KSL</div>
      <div class="space"></div>
      ${state.ksl.map(k=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>${k.title}</div>
            <a class="badge" href="javascript:void(0)" onclick="__toggleKSL('${k.id}')">${k.ok?'OK':'Ikke OK'}</a>
          </div>
        </div>
      `).join("")}
    </div>
  `);
  return {node,state};
}
window.__toggleKSL=function(id){
  const state=loadState();
  ensureKSL(state);
  const k=state.ksl.find(x=>x.id===id);
  if(k) k.ok=!k.ok;
  saveState(state);
  nav('/ksl');
};
(state, params){
  ensureFeedPlans(state);
  const node=h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Fôrplan</div><div class="muted">Sesongbasert</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>
      <div class="space"></div>
      <a class="btn" href="#/feed?add=1">Ny fôrplan</a>
      <div class="space"></div>
      ${state.feedPlans.filter(f=>f.active).map(f=>`
        <div class="card">
          <div><b>${f.name}</b> <span class="muted">(${f.season||""})</span></div>
          <div class="muted small">${f.notes||""}</div>
        </div>
      `).join("") || `<div class="card"><div class="muted">Ingen fôrplaner.</div></div>`}
    </div>
  `);
  return {node,state};
}
(state, params){
  ensureMeds(state);
  const adding = params.get("add")==="1";
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Medisinlager</div><div class="muted">Preparat, beholdning, tilbakehold</div></div>
        <a class="badge" href="#/dashboard">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="muted">Aktive: <b>${state.meds.filter(m=>m.active).length}</b></div>
        <a class="badge" href="#/meds?add=1">Legg til</a>
      </div>

      <div class="space"></div>

      ${state.meds.filter(m=>m.active).length ? state.meds.filter(m=>m.active).map(m=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div><b>${m.name}</b> <span class="muted">${m.batch?`• batch ${m.batch}`:""}</span></div>
              <div class="muted small">Beholdning: ${m.qty} ${m.unit} • Tilbakehold kjøtt: ${m.withdrawMeatDays}d • melk: ${m.withdrawMilkDays}d</div>
            </div>
            <a class="badge" href="javascript:void(0)" onclick="__delMed('${m.id}')">Slett</a>
          </div>
        </div>
      `).join("") : `<div class="card"><div class="muted">Ingen medisiner.</div></div>`}

      ${adding ? medsAddSheet() : ""}

    </div>
  `);
  return {node, state};
}
function medsAddSheet(){
  return `
    <div class="sheet-backdrop" onclick="location.hash='#/meds'"></div>
    <div class="sheet">
      <div class="h2">Ny medisin</div>
      <label>Navn</label><input id="md_name" class="input" placeholder="Ivomec" />
      <div class="space"></div>
      <label>Batch (valgfritt)</label><input id="md_batch" class="input" placeholder="1234" />
      <div class="space"></div>
      <label>Enhet</label>
      <select id="md_unit" class="input"><option>ml</option><option>mg</option><option>stk</option></select>
      <div class="space"></div>
      <label>Beholdning</label><input id="md_qty" class="input" type="number" placeholder="0" />
      <div class="space"></div>
      <label>Tilbakehold kjøtt (dager)</label><input id="md_wm" class="input" type="number" placeholder="0" />
      <div class="space"></div>
      <label>Tilbakehold melk (dager)</label><input id="md_wmilk" class="input" type="number" placeholder="0" />
      <div class="space"></div>
      <a class="btn primary" href="javascript:void(0)" onclick="__addMed()">Lagre</a>
      <div class="space"></div>
      <a class="btn" href="#/meds">Avbryt</a>
    </div>
  `;
}
window.__addMed = function(){
  const state = loadState();
  ensureMeds(state);
  const name=(document.querySelector("#md_name")?.value||"").trim();
  if(!name){ alert("Navn mangler"); return; }
  const batch=(document.querySelector("#md_batch")?.value||"").trim();
  const unit=document.querySelector("#md_unit")?.value||"ml";
  const qty=Number(document.querySelector("#md_qty")?.value||0);
  const wm=Number(document.querySelector("#md_wm")?.value||0);
  const wmilk=Number(document.querySelector("#md_wmilk")?.value||0);
  state.meds.push(newMed({name,batch,unit,qty,withdrawMeatDays:wm,withdrawMilkDays:wmilk}));
  saveState(state);
  nav("/meds");
};
window.__delMed = function(id){
  if(!confirm("Slette medisin?")) return;
  const state = loadState();
  ensureMeds(state);
  const m = state.meds.find(x=>x.id===id);
  if(m) m.active=false;
  saveState(state);
  nav("/meds");
};
(state, params){
  const cfg = getPriceConfig();
  const crops = ["GROVFOR","ENG","KORN","POTET"];
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Priser</div><div class="muted">Lokale estimater (kan endres)</div></div>
        <a class="badge" href="#/settings">Tilbake</a>
      </div>

      <div class="space"></div>

      ${crops.map(c=>{
        const p = pricesForCrop(c);
        return `
          <div class="card">
            <div class="h2">${c}</div>
            <label>Avlingspris (kr per “enhet”)</label>
            <input class="input" id="pr_y_${c}" type="number" value="${p.yieldPrice}" />
            <div class="space"></div>
            <label>N-kostnad (kr per kg N)</label>
            <input class="input" id="pr_n_${c}" type="number" value="${p.nCostPerKg}" />
          </div>
          <div class="space"></div>
        `;
      }).join("")}

      <a class="btn primary" href="javascript:void(0)" onclick="__savePrices()">Lagre</a>
    </div>
  `);
  return {node, state};
}
window.__savePrices = function(){
  const crops = ["GROVFOR","ENG","KORN","POTET"];
  const cfg = getPriceConfig();
  for(const c of crops){
    const y = Number(document.querySelector(`#pr_y_${c}`)?.value || 0);
    const n = Number(document.querySelector(`#pr_n_${c}`)?.value || 0);
    cfg[c] = { yieldPrice: y, nCostPerKg: n };
  }
  savePriceConfig(cfg);
  alert("Lagret");
  nav("/settings");
};

function pageProfiles(state, params){
  const profiles = listProfiles();
  const active = getActiveProfileId();
  const node = h(`
    <div class="container">
      <div class="row" style="justify-content:space-between;">
        <div><div class="h1">Gårdsprofiler</div><div class="muted">Flere gårder / test-data lokalt</div></div>
        <a class="badge" href="#/settings">Tilbake</a>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Aktiv profil</div>
        <div class="muted">Nå: <b>${active}</b></div>
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Profiler</div>
        ${profiles.length ? `
          <div class="list">
            ${profiles.map(p=>`
              <div class="item">
                <div><b>${p.id}</b> ${p.label?`<span class="muted">– ${p.label}</span>`:""}</div>
                <div class="row">
                  <a class="badge" href="javascript:void(0)" onclick="__switchProfile('${p.id}')">Bruk</a>
                  <a class="badge" href="javascript:void(0)" onclick="__deleteProfile('${p.id}')">Slett</a>
                </div>
              </div>
            `).join("")}
          </div>
        ` : `<div class="muted">Ingen profiler ennå.</div>`}
      </div>

      <div class="space"></div>

      <div class="card">
        <div class="h2">Ny profil</div>
        <div class="muted">Oppretter tom profil (kan importere backup etterpå)</div>
        <div class="space"></div>
        <label>ID (enkelt)</label>
        <input id="pr_id" class="input" placeholder="f.eks. rogaland_sau" />
        <div class="space"></div>
        <label>Navn/label</label>
        <input id="pr_label" class="input" placeholder="Rogaland småbruk" />
        <div class="space"></div>
        <a class="btn primary" href="javascript:void(0)" onclick="__createProfile()">Opprett</a>
      </div>
    </div>
  `);
  return {node, state};
}
window.__switchProfile = function(id){
  setActiveProfileId(id);
  alert("Byttet profil: " + id);
  nav("/dashboard");
};
window.__deleteProfile = function(id){
  if(!confirm("Slette profilen og alle data lokalt?")) return;
  const profiles = listProfiles().filter(p=>p.id!==id);
  saveProfiles(profiles);
  // remove storage
  localStorage.removeItem(storageKeyForProfile(id));
  if(getActiveProfileId()===id) setActiveProfileId("default");
  nav("/profiles");
};
window.__createProfile = function(){
  const id = (document.querySelector("#pr_id")?.value||"").trim();
  const label = (document.querySelector("#pr_label")?.value||"").trim();
  if(!id){ alert("Skriv en ID"); return; }
  const profiles = listProfiles();
  if(profiles.some(p=>p.id===id)){ alert("ID finnes"); return; }
  profiles.push({id, label});
  saveProfiles(profiles);
  // init empty state
  const empty = migrateState({animals:[],fields:[],events:[],tasks:[],meta:{}});
  localStorage.setItem(storageKeyForProfile(id), JSON.stringify(empty));
  setActiveProfileId(id);
  alert("Opprettet og aktivert: " + id);
  nav("/dashboard");
};

function quickSheet(){
  const node = h(`
    <div class="container">
      <div class="sheet-backdrop" id="bd"></div>
      <div class="sheet">
        <div class="h2">Hurtigregistrering</div>
        <div class="list">
          <a class="btn" href="#/log?new=TREATMENT">Behandling</a>
          <a class="btn" href="#/log?new=WEIGHT">Vekt</a>
          <a class="btn" href="#/log?new=MOVE">Flytting</a>
          <a class="btn" href="#/log?new=NOTE">Notat</a>
          <a class="btn" href="#/log?new=SPRAY">Sprøyting</a>
          <a class="btn" href="#/log?new=FERTILIZE">Gjødsling</a>
          <a class="btn" href="#/flock">Flokk</a>
          <a class="btn" href="#/work">Leiekjøring</a>
          <a class="btn" href="#/tasks?new=1">Oppgave</a>
        </div>
        <hr/>
        <a class="btn" href="#/dashboard">Lukk</a>
      </div>
    </div>
  `);
  setTimeout(()=> node.querySelector("#bd")?.addEventListener("click", ()=> nav("/dashboard")),0);
  return {node, state: loadState()};
}

let __timerInt = null;

function render(){
  const r = route();
  let state = loadState();

  let content;
  if(r.path==="/dashboard") content = pageDashboard(state);
  else if(r.path==="/flock") content = pageFlock(state, r.params);
  else if(r.path==="/insights") content = pageInsights(state);
  else if(r.path==="/animals") content = pageAnimals(state, r.params);
  else if(r.path==="/fields") content = pageFields(state, r.params);
  else if(r.path==="/log") content = pageLog(state, r.params);
  else if(r.path==="/tasks") content = pageTasks(state, r.params);
  else if(r.path==="/documents") content = pageDocuments(state, r.params);
  else if(r.path==="/med") content = pageMedInventory(state, r.params);
  else if(r.path==="/work") content = pageWork(state);
  else if(r.path==="/settings") content = pageSettings(state);
  else if(r.path==="/selftest") content = pageSelfTest(state);
  else if(r.path==="/reports") content = pageReports(state, r.params);
  else if(r.path==="/profiles") content = pageProfiles(state, r.params);
  else if(r.path==="/prices") content = pagePrices(state, r.params);
  else if(r.path==="/meds") content = pageMeds(state, r.params);
  else if(r.path==="/feed") content = pageFeedPlans(state, r.params);
  else if(r.path==="/ksl") content = pageKSL(state, r.params);
  else if(r.path==="/admin") content = pageAdminOverview(state, r.params);
  else if(r.path==="/groups") content = pageGroups(state, r.params);
  else if(r.path==="/groupkpi") content = pageGroupKPI(state, r.params);
  else if(r.path==="/slaughter") content = pageSlaughter(state, r.params);
  else if(r.path==="/archive") content = pageArchive(state, r.params);
  else if(r.path==="/production") content = pageProduction(state, r.params);
  else if(r.path==="/backup") content = pageBackup(state, r.params);
  else if(r.path==="/health") content = pageHealthSummary(state, r.params);
  else if(r.path==="/feedinv") content = pageFeedInventory(state, r.params);
  else if(r.path==="/economy") content = pageEconomy(state, r.params);
  else if(r.path==="/budget") content = pageBudget(state, r.params);
  else if(r.path==="/breeding") content = pageBreeding(state, r.params);
  else if(r.path==="/lambing") content = pageLambingOverview(state, r.params);
  else if(r.path==="/year") content = pageYearSummary(state, r.params);
  else if(r.path==="/pastures") content = pagePastures(state, r.params);
  else if(r.path==="/sheep") content = pageSheep(state, r.params);
  else if(r.path==="/sheepmove") content = pageSheepMove(state, r.params);
  else if(r.path==="/lambs") content = pageLambs(state, r.params);
  else if(r.path==="/weights") content = pageWeights(state, r.params);
  else if(r.path==="/scans") content = pageScans(state, r.params);
  else if(r.path==="/animal") content = pageAnimal(state, r.params);
  else if(r.path==="/due") content = pageDue(state, r.params);
  else if(r.path==="/sales") content = pageSales(state, r.params);
  else if(r.path==="/fieldplans") content = pageFieldPlans(state, r.params);
  else if(r.path==="/fieldplan") content = pageFieldPlan(state, r.params);
  else if(r.path==="/quick") content = quickSheet();
  else { nav("/dashboard"); return; }

  const wrap = h("<div></div>");
  wrap.appendChild(content.node);
  wrap.appendChild(bottomNav(r.path));
  setApp(wrap);

  if(__timerInt){ clearInterval(__timerInt); __timerInt = null; }

  if(r.path==="/log" && r.params.get("new")){
    const presetQ = r.params.get("q") || "";
    const autoSelect = r.params.get("autoSelect")==="1";
    setTimeout(()=> initEventSheet(presetQ, autoSelect), 0);
  }
  if(r.path==="/tasks" && r.params.get("new")==="1"){
    setTimeout(()=> {
      const d = new Date();
      const el = document.querySelector("#ta_date");
      if(el) el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    },0);
  }
  if(r.path==="/work"){
    const s = loadState();
    if(s.work.running){
      const tick = ()=>{
        const st = loadState().work.running;
        if(!st) return;
        const mins = minutesBetween(st.startedAt, nowISO());
        const mm = String(Math.floor(mins/60)).padStart(2,"0");
        const ss = String(mins%60).padStart(2,"0");
        const el = document.querySelector("#wo_timer");
        if(el) el.textContent = `${mm}:${ss}`;
      };
      tick();
      __timerInt = setInterval(tick, 1000);
    }
  }
}

window.addEventListener("hashchange", render);
render();
</script>
</body>
</html>
